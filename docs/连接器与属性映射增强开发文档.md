# Go-SyncFlow 连接器与属性映射增强 - 开发文档

> 版本：v3.3 | 日期：2026-02-10 | 状态：已实现

---

## 一、已实现功能清单

### 1.1 连接器类型

| 类型 | 编码 | 方向 | 说明 |
|------|------|------|------|
| 钉钉 | im_dingtalk | 上游 | 支持 SSO 免登 |
| 企业微信 | im_wechatwork | 上游 | 支持 SSO 免登 |
| 飞书 | im_feishu | 上游 | 支持 SSO 免登 |
| WeLink | im_welink | 上游 | - |
| LDAP AD | ldap_ad | 上下游 | Windows AD 域控 |
| LDAP 通用 | ldap_generic | 下游 | OpenLDAP 等标准 LDAP |
| MySQL | db_mysql | 上下游 | - |
| PostgreSQL | db_postgresql | 上下游 | - |
| Oracle | db_oracle | 上下游 | - |
| SQL Server | db_sqlserver | 上下游 | - |

### 1.2 下游属性映射

#### 对象类型
属性映射支持三种对象类型，在前端以「对象」列下拉选择：
- **用户** — 用户属性同步（username, nickname, email, phone, status 等）
- **群组** — 部门/OU 属性同步（name, description）
- **角色** — 角色/安全组属性同步（name, code, description）

#### LDAP AD 默认映射模板

| 对象 | 本地属性 | 目标属性 | 映射方式 | 转换规则 |
|------|---------|---------|---------|---------|
| 群组 | name | ou | 直接映射 | - |
| 群组 | name | description | 直接映射 | - |
| 角色 | name | cn | 直接映射 | - |
| 角色 | name | description | 直接映射 | - |
| 用户 | username | sAMAccountName | 直接映射 | - |
| 用户 | nickname | cn | 直接映射 | - |
| 用户 | nickname | displayName | 直接映射 | - |
| 用户 | email | mail | 直接映射 | - |
| 用户 | phone | mobile | 直接映射 | - |
| 用户 | password_raw | unicodePwd | 转换 | 密码转Unicode（AD） |
| 用户 | status | userAccountControl | 转换 | 状态转账户控制 |
| 用户 | nickname | description | 直接映射 | - |

#### 转换规则

| 规则 | 说明 |
|------|------|
| password_to_unicode | 密码编码为 AD unicodePwd 格式 |
| status_to_uac | 禁用时 AD 禁用账户（userAccountControl=66050） |
| status_to_delete | 禁用时从 AD 物理删除用户 |
| chinese_surname | 提取中文姓氏（第一个字） |
| chinese_given_name | 提取中文名字（除第一个字） |
| pinyin | 中文转拼音 |
| append:@domain.com | 追加域名后缀 |
| to_upper / to_lower | 大小写转换 |

#### LDAP 通用默认映射模板

| 对象 | 本地属性 | 目标属性 |
|------|---------|---------|
| 群组 | name | ou |
| 用户 | username | uid |
| 用户 | nickname | cn / displayName / sn |
| 用户 | email | mail |
| 用户 | phone | telephoneNumber |
| 用户 | password_hash | userPassword |

### 1.3 IM 通知系统

通知发送统一从上游连接器（connectors 表）读取 IM 配置，支持：
- 钉钉工作消息（从 im_dingtalk 连接器读取 AppKey/Secret/AgentID）
- 飞书工作消息（从 im_feishu 连接器读取）
- 企业微信工作消息（从 im_wechatwork 连接器读取）

验证码发送失败时返回错误（不再静默吞掉），前端显示实际错误信息。

### 1.4 AD 同步增强

- **事件触发单用户同步**：自动创建父 OU 层级，用户放入正确部门 OU
- **用户状态同步**：显式同步 userAccountControl（启用=66048，禁用=66050）
- **角色安全组同步**：事件触发时自动创建角色安全组并添加用户为成员
- **禁用用户处理**：可配置禁用时 AD 禁用或删除（通过属性映射转换规则）

### 1.5 API 安全限制

开放 API（/api/open/*）增加安全中间件：
- 禁止操作 admin 用户
- 禁止分配 super_admin 角色
- 不暴露密钥管理、日志删除、权限修改接口

### 1.6 用户删除

- 硬删除：物理删除数据库记录
- 触发下游同步事件（user_delete）
- 前端支持单个删除、批量删除
- admin 不可删除（前后端双重保护）
- 上游重新同步时自动重新创建已删除用户

---

## 二、技术实现细节

### 2.1 连接器密码存储

`models.Connector` 中 `BindPassword`、`DBPassword`、`IMAppSecret` 标记为 `json:"-"`（不返回前端）。
创建连接器时使用自定义 struct 接收 JSON，手动赋值到模型，确保密码正确存储。

### 2.2 属性映射查询

映射存储在 `sync_attribute_mappings` 表，同时支持旧 `synchronizer_id` 和新 `sync_rule_id`：
```sql
WHERE (synchronizer_id = ? OR sync_rule_id = ?) AND object_type = ? AND is_enabled = ?
```

### 2.3 下游同步规则默认配置

创建下游同步规则时自动：
- 订阅所有事件（user_create/update/delete/enable/disable/password_change/group_change/role_change）
- 启用 syncUsers/syncGroups/syncRoles
- 目标容器自动使用连接器 BaseDN
