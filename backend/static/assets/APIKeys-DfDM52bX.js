import{v as e,k as l,D as a,G as t,E as i,F as s,am as p,P as d,z as o,r as n,ac as u,ad as c,y as r,u as m,S as y,U as v,R as k,M as f,a6 as h,l as _,c as w}from"./vendor-DDTA3iPl.js";import{E as x,J as g,s as I,r as A,Q as b,K as V}from"./elementPlus-DW6qdM9Z.js";import{f as C,_ as K}from"./index-D9Oaf6TO.js";const L={class:"page-container"},B={class:"page-header"},z={class:"filter-bar"},P={class:"key-name"},U={key:0,class:"key-desc"},W={class:"app-id"},$={class:"app-key-hint"},D={key:1,class:"text-muted"},j={class:"usage-count"},H={class:"last-used"},E={key:0,class:"last-ip"},S={key:1,class:"text-muted"},T={key:0},X={key:1,class:"text-muted"},Y={class:"ip-list-editor"},F={class:"ip-list-editor"},M={class:"key-display"},R={class:"key-row"},N={class:"key-value"},q={class:"key-row"},G={class:"key-value key-secret"},J={class:"usage-example"},Q={class:"code-block"},O=K(e({__name:"APIKeys",setup(e){const K=n(!1),O=n(!1),Z=n(!1),ee=n(!1),le=n(null),ae=n([]),te=n(""),ie=n(""),se=n(!1),pe=n(!1),de=n(""),oe=n(""),ne=_({name:"",description:"",appId:"",appKey:"",ipWhitelist:[],ipBlacklist:[],rateLimit:60,expiresAt:""}),ue=_({appId:"",appKey:""}),ce=w(()=>window.location.origin),re=async()=>{K.value=!0;try{const e={};te.value&&(e.keyword=te.value),ie.value&&(e.status=ie.value);const{data:l}=await C.get("/apikeys",{params:e});ae.value=l.data||[]}catch(e){x.error("加载失败")}finally{K.value=!1}},me=()=>{le.value=null,ne.name="",ne.description="",ne.appId="",ne.appKey="",ne.ipWhitelist=[],ne.ipBlacklist=[],ne.rateLimit=60,ne.expiresAt="",se.value=!1,pe.value=!1,de.value="",oe.value="",Z.value=!0},ye=async()=>{var e,l;if(ne.name.trim()){O.value=!0;try{if(le.value)await C.put(`/apikeys/${le.value}`,{name:ne.name,description:ne.description,ipWhitelist:ne.ipWhitelist,ipBlacklist:ne.ipBlacklist,rateLimit:ne.rateLimit,expiresAt:ne.expiresAt||null}),x.success("更新成功");else{const{data:e}=await C.post("/apikeys",{name:ne.name,description:ne.description,appId:ne.appId||void 0,appKey:ne.appKey||void 0,ipWhitelist:ne.ipWhitelist,ipBlacklist:ne.ipBlacklist,rateLimit:ne.rateLimit,expiresAt:ne.expiresAt||void 0});ue.appId=e.data.appId,ue.appKey=e.data.appKey,ee.value=!0}Z.value=!1,re()}catch(a){x.error((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.message)||"操作失败")}finally{O.value=!1}}else x.warning("请输入名称")},ve=()=>{const e=de.value.trim();e&&!ne.ipWhitelist.includes(e)&&ne.ipWhitelist.push(e),de.value="",se.value=!1},ke=()=>{const e=oe.value.trim();e&&!ne.ipBlacklist.includes(e)&&ne.ipBlacklist.push(e),oe.value="",pe.value=!1},fe=async e=>{try{await navigator.clipboard.writeText(e),x.success("已复制")}catch{x.error("复制失败")}},he=()=>{const e=`curl -H "X-App-ID: ${ue.appId}" -H "X-App-Key: ${ue.appKey}" ${ce.value}/api/open/users`;fe(e)},_e=e=>{var l,a;const t=[];return(null==(l=e.ipWhiteList)?void 0:l.length)&&t.push(`白名单: ${e.ipWhiteList.join(", ")}`),(null==(a=e.ipBlackList)?void 0:a.length)&&t.push(`黑名单: ${e.ipBlackList.join(", ")}`),t.join(" | ")};return l(re),(e,l)=>{const n=u("el-icon"),_=u("el-button"),w=u("el-input"),we=u("el-option"),xe=u("el-select"),ge=u("el-table-column"),Ie=u("el-tag"),Ae=u("el-tooltip"),be=u("el-table"),Ve=u("el-form-item"),Ce=u("el-divider"),Ke=u("el-input-number"),Le=u("el-date-picker"),Be=u("el-form"),ze=u("el-dialog"),Pe=u("el-alert"),Ue=c("loading");return r(),a("div",L,[t("div",B,[l[21]||(l[21]=t("div",null,[t("h2",null,"API 密钥管理"),t("p",{class:"page-desc"},"管理开放接口的 AppID / AppKey，第三方系统可通过密钥调用 API")],-1)),i(_,{type:"primary",onClick:me},{default:s(()=>[i(n,null,{default:s(()=>[i(m(g))]),_:1}),l[20]||(l[20]=y("创建密钥 ",-1))]),_:1})]),t("div",z,[i(w,{modelValue:te.value,"onUpdate:modelValue":l[0]||(l[0]=e=>te.value=e),placeholder:"搜索名称 / AppID",clearable:"",style:{width:"260px"},onClear:re,onKeyup:p(re,["enter"])},{prefix:s(()=>[i(n,null,{default:s(()=>[i(m(I))]),_:1})]),_:1},8,["modelValue"]),i(xe,{modelValue:ie.value,"onUpdate:modelValue":l[1]||(l[1]=e=>ie.value=e),placeholder:"状态",clearable:"",style:{width:"120px"},onChange:re},{default:s(()=>[i(we,{label:"已启用",value:"active"}),i(we,{label:"已禁用",value:"inactive"})]),_:1},8,["modelValue"]),i(_,{onClick:re},{default:s(()=>[i(n,null,{default:s(()=>[i(m(A))]),_:1})]),_:1})]),d((r(),o(be,{data:ae.value,stripe:"",class:"modern-table","empty-text":"暂无 API 密钥"},{default:s(()=>[i(ge,{label:"名称","min-width":"160"},{default:s(({row:e})=>[t("div",P,v(e.name),1),e.description?(r(),a("div",U,v(e.description),1)):k("",!0)]),_:1}),i(ge,{prop:"appId",label:"AppID",width:"200"},{default:s(({row:e})=>[t("code",W,v(e.appId),1),i(_,{link:"",size:"small",onClick:l=>fe(e.appId),style:{"margin-left":"4px"}},{default:s(()=>[i(n,null,{default:s(()=>[i(m(b))]),_:1})]),_:1},8,["onClick"])]),_:1}),i(ge,{label:"AppKey",width:"140"},{default:s(({row:e})=>[t("code",$,v(e.appKeyHint),1)]),_:1}),i(ge,{label:"状态",width:"100",align:"center"},{default:s(({row:e})=>[e.isExpired?(r(),o(Ie,{key:0,type:"info",size:"small"},{default:s(()=>[...l[22]||(l[22]=[y("已过期",-1)])]),_:1})):(r(),o(Ie,{key:1,type:e.isActive?"success":"danger",size:"small"},{default:s(()=>[y(v(e.isActive?"已启用":"已禁用"),1)]),_:2},1032,["type"]))]),_:1}),i(ge,{label:"IP限制",width:"100",align:"center"},{default:s(({row:e})=>[e.ipWhiteList&&e.ipWhiteList.length||e.ipBlackList&&e.ipBlackList.length?(r(),o(Ae,{key:0,content:_e(e),placement:"top"},{default:s(()=>[i(Ie,{size:"small",type:"warning"},{default:s(()=>[...l[23]||(l[23]=[y("已配置",-1)])]),_:1})]),_:1},8,["content"])):(r(),a("span",D,"无限制"))]),_:1}),i(ge,{label:"调用次数",width:"100",align:"center"},{default:s(({row:e})=>{return[t("span",j,v((l=e.usageCount,l?l>1e4?(l/1e4).toFixed(1)+"w":l>1e3?(l/1e3).toFixed(1)+"k":String(l):"0")),1)];var l}),_:1}),i(ge,{label:"最后使用",width:"160"},{default:s(({row:e})=>{return[e.lastUsedAt?(r(),a(f,{key:0},[t("div",H,v((l=e.lastUsedAt,l?new Date(l).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"")),1),e.lastUsedIp?(r(),a("div",E,v(e.lastUsedIp),1)):k("",!0)],64)):(r(),a("span",S,"未使用"))];var l}),_:1}),i(ge,{label:"过期时间",width:"120"},{default:s(({row:e})=>{return[e.expiresAt?(r(),a("span",T,v((l=e.expiresAt,l?new Date(l).toLocaleDateString("zh-CN"):"")),1)):(r(),a("span",X,"永不过期"))];var l}),_:1}),i(ge,{label:"操作",width:"200",fixed:"right"},{default:s(({row:e})=>[i(_,{link:"",type:"primary",size:"small",onClick:l=>(e=>{le.value=e.id,ne.name=e.name,ne.description=e.description||"",ne.ipWhitelist=e.ipWhiteList||[],ne.ipBlacklist=e.ipBlackList||[],ne.rateLimit=e.rateLimit||60,ne.expiresAt=e.expiresAt?e.expiresAt.substring(0,10):"",Z.value=!0})(e)},{default:s(()=>[...l[24]||(l[24]=[y("编辑",-1)])]),_:1},8,["onClick"]),i(_,{link:"",type:e.isActive?"warning":"success",size:"small",onClick:l=>(async e=>{const l=e.isActive?"禁用":"启用";try{await V.confirm(`确定${l}密钥「${e.name}」？`,"提示",{type:"warning"}),await C.put(`/apikeys/${e.id}/toggle`),x.success(`${l}成功`),re()}catch{}})(e)},{default:s(()=>[y(v(e.isActive?"禁用":"启用"),1)]),_:2},1032,["type","onClick"]),i(_,{link:"",type:"primary",size:"small",onClick:l=>(async e=>{try{await V.confirm(`确定重置密钥「${e.name}」的 AppKey？重置后旧密钥将立即失效。`,"重置 AppKey",{type:"warning",confirmButtonText:"确定重置",cancelButtonText:"取消"});const{data:l}=await C.post(`/apikeys/${e.id}/reset`);ue.appId=l.data.appId,ue.appKey=l.data.appKey,ee.value=!0,re()}catch{}})(e)},{default:s(()=>[...l[25]||(l[25]=[y("重置",-1)])]),_:1},8,["onClick"]),i(_,{link:"",type:"danger",size:"small",onClick:l=>(async e=>{try{await V.confirm(`确定删除密钥「${e.name}」(${e.appId})？删除后无法恢复。`,"删除确认",{type:"danger",confirmButtonText:"确定删除"}),await C.delete(`/apikeys/${e.id}`),x.success("删除成功"),re()}catch{}})(e)},{default:s(()=>[...l[26]||(l[26]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ue,K.value]]),i(ze,{modelValue:Z.value,"onUpdate:modelValue":l[15]||(l[15]=e=>Z.value=e),title:le.value?"编辑 API 密钥":"创建 API 密钥",width:"640px","close-on-click-modal":!1},{footer:s(()=>[i(_,{onClick:l[14]||(l[14]=e=>Z.value=!1)},{default:s(()=>[...l[37]||(l[37]=[y("取消",-1)])]),_:1}),i(_,{type:"primary",loading:O.value,onClick:ye},{default:s(()=>[y(v(le.value?"保存":"创建"),1)]),_:1},8,["loading"])]),default:s(()=>[i(Be,{model:ne,"label-width":"100px","label-position":"top"},{default:s(()=>[i(Ve,{label:"名称",required:""},{default:s(()=>[i(w,{modelValue:ne.name,"onUpdate:modelValue":l[2]||(l[2]=e=>ne.name=e),placeholder:"如：ERP 系统集成",maxlength:"128","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(Ve,{label:"备注"},{default:s(()=>[i(w,{modelValue:ne.description,"onUpdate:modelValue":l[3]||(l[3]=e=>ne.description=e),type:"textarea",rows:2,placeholder:"用途描述、负责人等信息",maxlength:"512"},null,8,["modelValue"])]),_:1}),le.value?k("",!0):(r(),a(f,{key:0},[i(Ce,{"content-position":"left"},{default:s(()=>[...l[27]||(l[27]=[y("密钥配置",-1)])]),_:1}),i(Ve,{label:"AppID"},{default:s(()=>[i(w,{modelValue:ne.appId,"onUpdate:modelValue":l[5]||(l[5]=e=>ne.appId=e),placeholder:"留空自动生成（格式：ak_xxxxxx）"},{append:s(()=>[i(_,{onClick:l[4]||(l[4]=e=>ne.appId="")},{default:s(()=>[...l[28]||(l[28]=[y("自动生成",-1)])]),_:1})]),_:1},8,["modelValue"]),l[29]||(l[29]=t("div",{class:"form-tip"},"唯一标识，创建后不可修改",-1))]),_:1}),i(Ve,{label:"AppKey"},{default:s(()=>[i(w,{modelValue:ne.appKey,"onUpdate:modelValue":l[7]||(l[7]=e=>ne.appKey=e),placeholder:"留空自动生成（64位随机字符串）",type:"password","show-password":""},{append:s(()=>[i(_,{onClick:l[6]||(l[6]=e=>ne.appKey="")},{default:s(()=>[...l[30]||(l[30]=[y("自动生成",-1)])]),_:1})]),_:1},8,["modelValue"]),l[31]||(l[31]=t("div",{class:"form-tip"},"密钥仅在创建时显示一次，请妥善保存",-1))]),_:1})],64)),i(Ce,{"content-position":"left"},{default:s(()=>[...l[32]||(l[32]=[y("访问控制",-1)])]),_:1}),i(Ve,{label:"IP 白名单"},{default:s(()=>[t("div",Y,[(r(!0),a(f,null,h(ne.ipWhitelist,(e,l)=>(r(),o(Ie,{key:"wl-"+l,closable:"",onClose:e=>ne.ipWhitelist.splice(l,1),style:{margin:"2px 4px 2px 0"}},{default:s(()=>[y(v(e),1)]),_:2},1032,["onClose"]))),128)),se.value?(r(),o(w,{key:0,modelValue:de.value,"onUpdate:modelValue":l[8]||(l[8]=e=>de.value=e),size:"small",style:{width:"180px"},placeholder:"输入 IP 后回车",onKeyup:p(ve,["enter"]),onBlur:ve},null,8,["modelValue"])):(r(),o(_,{key:1,size:"small",onClick:l[9]||(l[9]=e=>se.value=!0)},{default:s(()=>[...l[33]||(l[33]=[y("+ 添加IP",-1)])]),_:1}))]),l[34]||(l[34]=t("div",{class:"form-tip"},"配置后仅允许白名单内 IP 调用，支持 CIDR（如 10.0.0.0/8）和通配符（如 192.168.1.*）",-1))]),_:1}),i(Ve,{label:"IP 黑名单"},{default:s(()=>[t("div",F,[(r(!0),a(f,null,h(ne.ipBlacklist,(e,l)=>(r(),o(Ie,{key:"bl-"+l,closable:"",type:"danger",onClose:e=>ne.ipBlacklist.splice(l,1),style:{margin:"2px 4px 2px 0"}},{default:s(()=>[y(v(e),1)]),_:2},1032,["onClose"]))),128)),pe.value?(r(),o(w,{key:0,modelValue:oe.value,"onUpdate:modelValue":l[10]||(l[10]=e=>oe.value=e),size:"small",style:{width:"180px"},placeholder:"输入 IP 后回车",onKeyup:p(ke,["enter"]),onBlur:ke},null,8,["modelValue"])):(r(),o(_,{key:1,size:"small",onClick:l[11]||(l[11]=e=>pe.value=!0)},{default:s(()=>[...l[35]||(l[35]=[y("+ 添加IP",-1)])]),_:1}))])]),_:1}),i(Ve,{label:"频率限制"},{default:s(()=>[i(Ke,{modelValue:ne.rateLimit,"onUpdate:modelValue":l[12]||(l[12]=e=>ne.rateLimit=e),min:1,max:1e4,step:10},null,8,["modelValue"]),l[36]||(l[36]=t("span",{style:{"margin-left":"8px",color:"#999"}},"次/分钟",-1))]),_:1}),i(Ve,{label:"过期时间"},{default:s(()=>[i(Le,{modelValue:ne.expiresAt,"onUpdate:modelValue":l[13]||(l[13]=e=>ne.expiresAt=e),type:"date",placeholder:"留空则永不过期","value-format":"YYYY-MM-DD",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),i(ze,{modelValue:ee.value,"onUpdate:modelValue":l[19]||(l[19]=e=>ee.value=e),title:"API 密钥信息",width:"540px","close-on-click-modal":!1},{footer:s(()=>[i(_,{type:"primary",onClick:l[18]||(l[18]=e=>ee.value=!1)},{default:s(()=>[...l[45]||(l[45]=[y("我已安全保存",-1)])]),_:1})]),default:s(()=>[i(Pe,{type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:s(()=>[...l[38]||(l[38]=[y(" 请立即复制并安全保存以下密钥信息，关闭后将无法再次查看完整 AppKey。 ",-1)])]),_:1}),t("div",M,[t("div",R,[l[40]||(l[40]=t("span",{class:"key-label"},"AppID",-1)),t("code",N,v(ue.appId),1),i(_,{size:"small",onClick:l[16]||(l[16]=e=>fe(ue.appId))},{default:s(()=>[...l[39]||(l[39]=[y("复制",-1)])]),_:1})]),t("div",q,[l[42]||(l[42]=t("span",{class:"key-label"},"AppKey",-1)),t("code",G,v(ue.appKey),1),i(_,{size:"small",onClick:l[17]||(l[17]=e=>fe(ue.appKey))},{default:s(()=>[...l[41]||(l[41]=[y("复制",-1)])]),_:1})])]),i(Ce),t("div",J,[l[44]||(l[44]=t("h4",null,"调用示例",-1)),t("div",Q,[t("pre",null,'curl -H "X-App-ID: '+v(ue.appId)+'" \\\n     -H "X-App-Key: '+v(ue.appKey)+'" \\\n     '+v(ce.value)+"/api/open/users",1)]),i(_,{size:"small",onClick:he,style:{"margin-top":"8px"}},{default:s(()=>[...l[43]||(l[43]=[y("复制示例",-1)])]),_:1})])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-72cce673"]]);export{O as default};
