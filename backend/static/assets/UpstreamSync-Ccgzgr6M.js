import{J as e,r as l,G as a,E as t,K as u}from"./elementPlus-DW6qdM9Z.js";import{b as d,r as o,_ as i}from"./index-D9Oaf6TO.js";import{v as n,k as s,D as r,E as m,F as p,r as c,ac as v,y as b,G as f,u as h,S as y,P as _,z as V,U as g,I as w,M as k,R as U,a6 as I,c as D,ad as S}from"./vendor-DDTA3iPl.js";const A={class:"upstream-page"},T={class:"tab-toolbar"},C={class:"row-name"},x={key:0,class:"conn-addr"},R={key:1,class:"conn-addr"},z={key:1,class:"text-muted"},P={class:"tab-toolbar"},M={class:"row-name"},q={class:"trigger-tags"},L={key:2,class:"text-muted"},E={class:"addr-row"},F={class:"addr-row"},N={class:"schedule-times-list"},O={class:"mapping-header"},j={class:"mapping-info"},B={class:"mapping-rule-name"},W={class:"mapping-actions"},Q={key:1,class:"text-muted",style:{"font-size":"12px"}},H=i(n({__name:"UpstreamSync",setup(i){const n=e=>null==e?void 0:e.startsWith("im_"),H=e=>null==e?void 0:e.startsWith("db_"),K=e=>({im_dingtalk:"钉钉",im_wechatwork:"企业微信",im_feishu:"飞书",im_welink:"WeLink",ldap_ad:"LDAP AD",db_mysql:"MySQL",db_postgresql:"PostgreSQL",db_oracle:"Oracle",db_sqlserver:"SQL Server"}[e]||e),J=e=>(null==e?void 0:e.startsWith("im_"))?"primary":(null==e?void 0:e.startsWith("db_"))?"success":"ldap_ad"===e?"warning":"info",$={db_mysql:3306,db_postgresql:5432,db_oracle:1521,db_sqlserver:1433},G=e=>{if(!e)return"-";try{const l=JSON.parse(e);if(Array.isArray(l))return l.join(", ")}catch{}return e},X=c("connectors"),Y=c([]),Z=c(!1),ee=c(0),le=c(!1),ae=c(!1),te=c(0),ue=c(!1),de=c([]),oe={name:"",type:"im_dingtalk",direction:"upstream",imAppId:"",imAppSecret:"",imCorpId:"",imAgentId:"",imMatchField:"mobile",imUsernameRule:"pinyin",imAutoRegister:!0,imDefaultRoleId:0,imEnableSso:!1,imSsoLabel:"",imSsoPriority:0,host:"",port:389,useTls:!1,baseDn:"",bindDn:"",bindPassword:"",userFilter:"",upnSuffix:"",database:"",dbUser:"",dbPassword:"",userTable:"",charset:"utf8mb4",timeout:5},ie=c({...oe}),ne=async()=>{var e;Z.value=!0;try{const l=await d.upstreamConnectors();Y.value=(null==(e=l.data)?void 0:e.data)||[]}finally{Z.value=!1}},se=e=>{ie.value={...oe},e?(ae.value=!0,te.value=e.id,ie.value={name:e.name,type:e.type,direction:"upstream",imAppId:e.imAppId||"",imAppSecret:"",imCorpId:e.imCorpId||"",imAgentId:e.imAgentId||"",imMatchField:e.imMatchField||"mobile",imUsernameRule:e.imUsernameRule||"pinyin",imAutoRegister:e.imAutoRegister??!0,imDefaultRoleId:e.imDefaultRoleId||0,imEnableSso:e.imEnableSso??!1,imSsoLabel:e.imSsoLabel||"",imSsoPriority:e.imSsoPriority||0,host:e.host||"",port:e.port||389,useTls:e.useTls??!1,baseDn:e.baseDn||"",bindDn:e.bindDn||"",bindPassword:"",userFilter:e.userFilter||"",upnSuffix:e.upnSuffix||"",database:e.database||"",dbUser:e.dbUser||"",dbPassword:"",userTable:e.userTable||"",charset:e.charset||"utf8mb4",timeout:e.timeout||5}):(ae.value=!1,te.value=0),le.value=!0},re=e=>{if("ldap_ad"===e)ie.value.port=ie.value.useTls?636:389,ie.value.imEnableSso=!1;else if(H(e))ie.value.port=$[e]||3306,ie.value.imEnableSso=!1;else{const l={im_dingtalk:"钉钉登录",im_wechatwork:"企微登录",im_feishu:"飞书登录"};ie.value.imSsoLabel=l[e]||""}},me=e=>{ie.value.port=e?636:389},pe=async()=>{if(!ie.value.name)return void t.warning("请填写连接器名称");const e=ie.value.type;if(!n(e)||ie.value.imAppId)if("ldap_ad"!==e||ie.value.host&&ie.value.baseDn)if(!H(e)||ie.value.host&&ie.value.database){ue.value=!0;try{ae.value?(await d.updateUpstreamConnector(te.value,ie.value),ce(te.value,ie.value.imMatchField,ie.value.imUsernameRule)):await d.createUpstreamConnector(ie.value),t.success("保存成功"),le.value=!1,ne()}finally{ue.value=!1}}else t.warning("请填写服务器地址和数据库名");else t.warning("请填写服务器地址和 Base DN");else t.warning("请填写 AppID / AppKey")},ce=async(e,l,a)=>{var t;const u=ve.value.filter(l=>l.connectorId===e);for(const o of u)try{const e=(null==(t=(await d.upstreamRuleMappings(o.id)).data)?void 0:t.data)||[];let l=!1;for(const t of e)"username"===t.targetAttribute&&"transform"===t.mappingType&&t.transformRule!==a&&(t.transformRule=a,l=!0);l&&await d.updateUpstreamRuleMappings(o.id,e)}catch{}},ve=c([]),be=c(!1),fe=c(0),he=c(!1),ye=c(!1),_e=c(0),Ve=c(!1),ge={name:"",connectorId:0,direction:"upstream",scopeType:"all",scopeDeptIds:"",enableSchedule:!1,scheduleType:"times",scheduleTimes:[],scheduleInterval:60,enableChangeDetect:!1,changeDetectInterval:60,changeDetectField:"updated_at",statusBool:!0},we=c({...ge}),ke=()=>{we.value.scheduleTimes.push("08:00")},Ue=D(()=>{const e=Y.value.find(e=>e.id===we.value.connectorId);return(null==e?void 0:e.type)||""}),Ie=async()=>{var e;be.value=!0;try{const l=await d.upstreamRules();ve.value=(null==(e=l.data)?void 0:e.data)||[]}finally{be.value=!1}},De=e=>{if(!e)return[];try{const l=JSON.parse(e);if(Array.isArray(l))return l}catch{}return e.includes(",")?e.split(",").map(e=>e.trim()).filter(Boolean):[e]},Se=e=>{we.value={...ge,scheduleTimes:[]},e?(ye.value=!0,_e.value=e.id,we.value={name:e.name,connectorId:e.connectorId,direction:"upstream",scopeType:e.scopeType||"all",scopeDeptIds:e.scopeDeptIds||"",enableSchedule:e.enableSchedule??!1,scheduleType:e.scheduleType||"times",scheduleTimes:De(e.scheduleTime),scheduleInterval:e.scheduleInterval||60,enableChangeDetect:e.enableChangeDetect??!1,changeDetectInterval:e.changeDetectInterval||60,changeDetectField:e.changeDetectField||"updated_at",statusBool:1===e.status}):(ye.value=!1,_e.value=0,Y.value.length>0&&(we.value.connectorId=Y.value[0].id)),he.value=!0},Ae=async()=>{if(we.value.name&&we.value.connectorId)if(we.value.enableSchedule&&"times"===we.value.scheduleType&&0===we.value.scheduleTimes.length)t.warning("请至少添加一个定时同步时间");else{Ve.value=!0;try{const e={...we.value,status:we.value.statusBool?1:0};ye.value?await d.updateUpstreamRule(_e.value,e):await d.createUpstreamRule(e),t.success("保存成功"),he.value=!1,Ie()}finally{Ve.value=!1}}else t.warning("请填写必填项")},Te=c(!1),Ce=c(!1),xe=c(!1),Re=c(0),ze=c(""),Pe=c(""),Me=c(0),qe=c([]),Le=[{value:"name",label:"姓名 (name)"},{value:"mobile",label:"手机号 (mobile)"},{value:"email",label:"邮箱 (email)"},{value:"userid",label:"用户ID (userid)"},{value:"avatar",label:"头像 (avatar)"},{value:"title",label:"职位 (title)"},{value:"unionid",label:"UnionID (unionid)"},{value:"openid",label:"OpenID (openid)"}],Ee=[{value:"sAMAccountName",label:"登录名 (sAMAccountName)"},{value:"cn",label:"通用名 (cn)"},{value:"displayName",label:"显示名 (displayName)"},{value:"mail",label:"邮箱 (mail)"},{value:"mobile",label:"手机号 (mobile)"},{value:"telephoneNumber",label:"电话 (telephoneNumber)"},{value:"title",label:"职位 (title)"},{value:"department",label:"部门 (department)"},{value:"userPrincipalName",label:"UPN (userPrincipalName)"},{value:"givenName",label:"名 (givenName)"},{value:"sn",label:"姓 (sn)"}],Fe=[{value:"username",label:"用户名 (username)"},{value:"name",label:"姓名 (name)"},{value:"display_name",label:"显示名 (display_name)"},{value:"email",label:"邮箱 (email)"},{value:"phone",label:"手机号 (phone)"},{value:"mobile",label:"手机号 (mobile)"},{value:"password",label:"密码 (password)"},{value:"department",label:"部门 (department)"},{value:"position",label:"职位 (position)"}],Ne=[{value:"name",label:"部门名称 (name)"},{value:"deptId",label:"部门ID (deptId)"},{value:"parentId",label:"父部门ID (parentId)"}],Oe=[{value:"ou",label:"组织单元 (ou)"},{value:"cn",label:"通用名 (cn)"},{value:"description",label:"描述 (description)"}],je=[{value:"username",label:"用户名 (username)"},{value:"nickname",label:"昵称 (nickname)"},{value:"email",label:"邮箱 (email)"},{value:"phone",label:"手机号 (phone)"},{value:"avatar",label:"头像 (avatar)"},{value:"position",label:"职位 (position)"},{value:"department",label:"部门 (department)"},{value:"im_user_id",label:"IM用户ID (im_user_id)"},{value:"password_hash",label:"密码哈希 (password_hash)"}],Be=[{value:"name",label:"群组名称 (name)"},{value:"description",label:"描述 (description)"},{value:"remote_dept_id",label:"远程部门ID (remote_dept_id)"}],We=async()=>{var e;Ce.value=!0;try{const l=await d.upstreamRuleMappings(Re.value);qe.value=((null==(e=l.data)?void 0:e.data)||[]).map(e=>({...e,isEnabled:e.isEnabled??!0}))}finally{Ce.value=!1}},Qe=()=>{const e=qe.value.reduce((e,l)=>Math.max(e,l.priority||0),0);qe.value.push({objectType:"user",sourceAttribute:"",targetAttribute:"",mappingType:"mapping",transformRule:"",priority:e+1,isEnabled:!0})},He=async()=>{xe.value=!0;try{await d.updateUpstreamRuleMappings(Re.value,qe.value);const e=qe.value.find(e=>"username"===e.targetAttribute&&"transform"===e.mappingType&&e.isEnabled);if(e&&Me.value){const l=e.transformRule||"",a=Y.value.find(e=>e.id===Me.value);a&&a.imUsernameRule!==l&&(await d.updateUpstreamConnector(Me.value,{imUsernameRule:l}),ne())}t.success("映射已保存"),Te.value=!1}finally{xe.value=!1}},Ke=async()=>{var e;try{await u.confirm("将根据连接器类型恢复默认属性映射，当前自定义映射将被覆盖。确定？","恢复默认映射",{type:"warning"}),Ce.value=!0;const l=await d.resetUpstreamRuleMappings(Re.value);qe.value=((null==(e=l.data)?void 0:e.data)||[]).map(e=>({...e,isEnabled:e.isEnabled??!0})),t.success("已恢复默认映射")}catch{}finally{Ce.value=!1}};return s(()=>{ne(),Ie(),(async()=>{var e;try{const l=await o.list();de.value=(null==(e=l.data)?void 0:e.data)||[]}catch{}})()}),(o,i)=>{const s=v("el-icon"),c=v("el-button"),D=v("el-table-column"),$=v("el-tag"),te=v("el-empty"),oe=v("el-table"),ce=v("el-tab-pane"),_e=v("el-tabs"),ge=v("el-input"),De=v("el-form-item"),Je=v("el-option"),$e=v("el-option-group"),Ge=v("el-select"),Xe=v("el-divider"),Ye=v("el-switch"),Ze=v("el-input-number"),el=v("el-form"),ll=v("el-dialog"),al=v("el-radio"),tl=v("el-radio-group"),ul=v("el-time-picker"),dl=v("el-alert"),ol=S("loading");return b(),r("div",A,[m(_e,{modelValue:X.value,"onUpdate:modelValue":i[2]||(i[2]=e=>X.value=e),type:"border-card"},{default:p(()=>[m(ce,{label:"上游连接器",name:"connectors"},{default:p(()=>[f("div",T,[i[53]||(i[53]=f("span",{class:"tab-desc"},"配置IM平台、LDAP/AD或数据库作为上游用户数据源，同步至本地",-1)),m(c,{type:"primary",onClick:i[0]||(i[0]=e=>se())},{default:p(()=>[m(s,null,{default:p(()=>[m(h(e))]),_:1}),i[52]||(i[52]=y(" 新增连接器 ",-1))]),_:1})]),_((b(),V(oe,{data:Y.value,stripe:"",size:"small"},{empty:p(()=>[m(te,{description:"暂无上游连接器","image-size":100})]),default:p(()=>[m(D,{prop:"name",label:"名称","min-width":"140"},{default:p(({row:e})=>[f("span",C,g(e.name),1)]),_:1}),m(D,{label:"类型",width:"140",align:"center"},{default:p(({row:e})=>[m($,{type:J(e.type),size:"small",effect:"light"},{default:p(()=>[y(g(K(e.type)),1)]),_:2},1032,["type"])]),_:1}),m(D,{label:"地址","min-width":"160"},{default:p(({row:e})=>[n(e.type)?(b(),r("span",x,g(e.imAppId?"已配置":"未配置"),1)):(b(),r("span",R,g(e.host)+g(e.port?":"+e.port:""),1))]),_:1}),m(D,{label:"SSO",width:"70",align:"center"},{default:p(({row:e})=>[e.imEnableSso?(b(),V($,{key:0,type:"success",size:"small",effect:"light"},{default:p(()=>[...i[54]||(i[54]=[y("开",-1)])]),_:1})):(b(),r("span",z,"-"))]),_:1}),m(D,{label:"健康",width:"90",align:"center"},{default:p(({row:e})=>[f("span",{class:w(["health-dot",{online:e.lastTestOk,offline:e.lastTestAt&&!e.lastTestOk}])},null,2),y(" "+g(e.lastTestOk?"正常":e.lastTestAt?"异常":"未测试"),1)]),_:1}),m(D,{label:"操作",width:"200",fixed:"right"},{default:p(({row:e})=>[m(c,{type:"primary",link:"",size:"small",onClick:l=>(async e=>{var l,a,u;ee.value=e.id;try{const a=null==(l=(await d.testUpstreamConnector(e.id)).data)?void 0:l.data;(null==a?void 0:a.ok)?t.success((null==a?void 0:a.message)||"连接成功"):t.error((null==a?void 0:a.message)||"连接失败"),ne()}catch(o){t.error((null==(u=null==(a=null==o?void 0:o.response)?void 0:a.data)?void 0:u.message)||"连接失败"),ne()}finally{ee.value=0}})(e),loading:ee.value===e.id},{default:p(()=>[...i[55]||(i[55]=[y("测试",-1)])]),_:1},8,["onClick","loading"]),m(c,{type:"primary",link:"",size:"small",onClick:l=>se(e)},{default:p(()=>[...i[56]||(i[56]=[y("编辑",-1)])]),_:1},8,["onClick"]),m(c,{type:"danger",link:"",size:"small",onClick:l=>(async e=>{try{await u.confirm(`确定删除连接器「${e.name}」？关联的同步规则也会失效。`,"确认删除",{type:"warning"}),await d.deleteUpstreamConnector(e.id),t.success("删除成功"),ne()}catch{}})(e)},{default:p(()=>[...i[57]||(i[57]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ol,Z.value]])]),_:1}),m(ce,{label:"同步规则",name:"rules"},{default:p(()=>[f("div",P,[i[59]||(i[59]=f("span",{class:"tab-desc"},"定义从上游数据源同步用户到本地系统的规则",-1)),m(c,{type:"primary",onClick:i[1]||(i[1]=e=>Se())},{default:p(()=>[m(s,null,{default:p(()=>[m(h(e))]),_:1}),i[58]||(i[58]=y(" 新增规则 ",-1))]),_:1})]),_((b(),V(oe,{data:ve.value,stripe:"",size:"small"},{empty:p(()=>[m(te,{description:"暂无同步规则","image-size":100})]),default:p(()=>[m(D,{prop:"name",label:"规则名称","min-width":"160"},{default:p(({row:e})=>[f("span",M,g(e.name),1)]),_:1}),m(D,{label:"连接器",width:"150"},{default:p(({row:e})=>{var l;return[m($,{size:"small",effect:"light",type:J(null==(l=e.connector)?void 0:l.type)},{default:p(()=>{var l;return[y(g((null==(l=e.connector)?void 0:l.name)||"-"),1)]}),_:2},1032,["type"])]}),_:1}),m(D,{label:"触发方式",width:"200"},{default:p(({row:e})=>[f("div",q,[e.enableSchedule?(b(),r(k,{key:0},["interval"===e.scheduleType||!e.scheduleType&&e.scheduleInterval?(b(),V($,{key:0,type:"primary",size:"small",effect:"light"},{default:p(()=>[y(" 间隔 "+g(e.scheduleInterval||60)+"分钟 ",1)]),_:2},1024)):(b(),V($,{key:1,type:"primary",size:"small",effect:"light"},{default:p(()=>[y(" 定点 "+g(G(e.scheduleTime)),1)]),_:2},1024))],64)):U("",!0),e.enableChangeDetect?(b(),V($,{key:1,type:"warning",size:"small",effect:"light"},{default:p(()=>[y(" 变更检测 "+g(e.changeDetectInterval||60)+"s ",1)]),_:2},1024)):U("",!0),e.enableSchedule||e.enableChangeDetect?U("",!0):(b(),r("span",L,"手动"))])]),_:1}),m(D,{label:"状态",width:"80",align:"center"},{default:p(({row:e})=>[m($,{type:1===e.status?"success":"danger",size:"small",effect:"light"},{default:p(()=>[y(g(1===e.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),m(D,{label:"操作",width:"280",fixed:"right"},{default:p(({row:e})=>[m(c,{type:"success",link:"",size:"small",onClick:l=>(async e=>{var l,a;fe.value=e.id;try{await d.triggerUpstreamRule(e.id),t({message:"上游同步已触发，正在后台执行...",type:"success",duration:5e3});const l=setInterval(()=>Ie(),3e3);setTimeout(()=>clearInterval(l),3e4)}catch(u){t.error((null==(a=null==(l=null==u?void 0:u.response)?void 0:l.data)?void 0:a.message)||"同步触发失败")}finally{fe.value=0}})(e),loading:fe.value===e.id},{default:p(()=>[m(s,null,{default:p(()=>[m(h(l))]),_:1}),i[60]||(i[60]=y(" 同步 ",-1))]),_:1},8,["onClick","loading"]),m(c,{type:"primary",link:"",size:"small",onClick:l=>(async e=>{var l,a;Re.value=e.id,ze.value=e.name,Pe.value=(null==(l=e.connector)?void 0:l.type)||"",Me.value=e.connectorId||(null==(a=e.connector)?void 0:a.id)||0,Te.value=!0,await We()})(e)},{default:p(()=>[...i[61]||(i[61]=[y("映射",-1)])]),_:1},8,["onClick"]),m(c,{type:"primary",link:"",size:"small",onClick:l=>Se(e)},{default:p(()=>[...i[62]||(i[62]=[y("编辑",-1)])]),_:1},8,["onClick"]),m(c,{type:"danger",link:"",size:"small",onClick:l=>(async e=>{try{await u.confirm(`确定删除规则「${e.name}」？`,"确认删除",{type:"warning"}),await d.deleteUpstreamRule(e.id),t.success("删除成功"),Ie()}catch{}})(e)},{default:p(()=>[...i[63]||(i[63]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ol,be.value]])]),_:1})]),_:1},8,["modelValue"]),m(ll,{modelValue:le.value,"onUpdate:modelValue":i[36]||(i[36]=e=>le.value=e),title:ae.value?"编辑上游连接器":"新增上游连接器",width:"700px","destroy-on-close":""},{footer:p(()=>[m(c,{onClick:i[35]||(i[35]=e=>le.value=!1)},{default:p(()=>[...i[78]||(i[78]=[y("取消",-1)])]),_:1}),m(c,{type:"primary",onClick:pe,loading:ue.value},{default:p(()=>[...i[79]||(i[79]=[y("保存",-1)])]),_:1},8,["loading"])]),default:p(()=>[m(el,{model:ie.value,"label-width":"120px"},{default:p(()=>[m(De,{label:"连接器名称",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.name,"onUpdate:modelValue":i[3]||(i[3]=e=>ie.value.name=e),placeholder:"如：钉钉-总公司 / AD域用户源"},null,8,["modelValue"])]),_:1}),m(De,{label:"连接器类型",required:""},{default:p(()=>[m(Ge,{modelValue:ie.value.type,"onUpdate:modelValue":i[4]||(i[4]=e=>ie.value.type=e),class:"full-width",disabled:ae.value,onChange:re},{default:p(()=>[m($e,{label:"IM 平台"},{default:p(()=>[m(Je,{label:"钉钉 DingTalk",value:"im_dingtalk"}),m(Je,{label:"企业微信 WeChatWork",value:"im_wechatwork"}),m(Je,{label:"飞书 FeiShu",value:"im_feishu"}),m(Je,{label:"WeLink",value:"im_welink"})]),_:1}),m($e,{label:"目录服务"},{default:p(()=>[m(Je,{label:"LDAP / Active Directory",value:"ldap_ad"})]),_:1}),m($e,{label:"数据库"},{default:p(()=>[m(Je,{label:"MySQL",value:"db_mysql"}),m(Je,{label:"PostgreSQL",value:"db_postgresql"}),m(Je,{label:"Oracle",value:"db_oracle"}),m(Je,{label:"SQL Server",value:"db_sqlserver"})]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),n(ie.value.type)?(b(),r(k,{key:0},[m(Xe,{"content-position":"left"},{default:p(()=>[...i[64]||(i[64]=[y("应用凭证",-1)])]),_:1}),m(De,{label:"AppID / AppKey",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.imAppId,"onUpdate:modelValue":i[5]||(i[5]=e=>ie.value.imAppId=e),placeholder:"应用的 AppKey / AppID"},null,8,["modelValue"])]),_:1}),m(De,{label:"AppSecret",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.imAppSecret,"onUpdate:modelValue":i[6]||(i[6]=e=>ie.value.imAppSecret=e),type:"password","show-password":"",placeholder:ae.value?"留空不修改":"应用的 AppSecret"},null,8,["modelValue","placeholder"])]),_:1}),"im_dingtalk"===ie.value.type||"im_wechatwork"===ie.value.type?(b(),V(De,{key:0,label:"CorpID"},{default:p(()=>[m(ge,{modelValue:ie.value.imCorpId,"onUpdate:modelValue":i[7]||(i[7]=e=>ie.value.imCorpId=e),placeholder:"企业 CorpID"},null,8,["modelValue"])]),_:1})):U("",!0),"im_dingtalk"===ie.value.type?(b(),V(De,{key:1,label:"AgentID"},{default:p(()=>[m(ge,{modelValue:ie.value.imAgentId,"onUpdate:modelValue":i[8]||(i[8]=e=>ie.value.imAgentId=e),placeholder:"应用的 AgentID（用于发送工作通知）"},null,8,["modelValue"])]),_:1})):U("",!0),m(Xe,{"content-position":"left"},{default:p(()=>[...i[65]||(i[65]=[y("同步配置",-1)])]),_:1}),m(De,{label:"用户匹配字段"},{default:p(()=>[m(Ge,{modelValue:ie.value.imMatchField,"onUpdate:modelValue":i[9]||(i[9]=e=>ie.value.imMatchField=e),class:"full-width"},{default:p(()=>[m(Je,{label:"手机号 (mobile)",value:"mobile"}),m(Je,{label:"邮箱 (email)",value:"email"}),m(Je,{label:"IM平台UserID (userid)",value:"userid"}),m(Je,{label:"用户名 (username)",value:"username"})]),_:1},8,["modelValue"]),i[66]||(i[66]=f("div",{class:"field-hint"},"用于匹配上游用户与本地用户的字段，修改后会同步到属性映射",-1))]),_:1}),m(De,{label:"用户名生成"},{default:p(()=>[m(Ge,{modelValue:ie.value.imUsernameRule,"onUpdate:modelValue":i[10]||(i[10]=e=>ie.value.imUsernameRule=e),class:"full-width"},{default:p(()=>[m(Je,{label:"中文转拼音（重名加数字）",value:"pinyin"}),m(Je,{label:"邮箱前缀",value:"email_prefix"}),m(Je,{label:"手机号",value:"mobile"}),m(Je,{label:"邮箱",value:"email"}),m(Je,{label:"IM平台UserID",value:"userid"})]),_:1},8,["modelValue"]),i[67]||(i[67]=f("div",{class:"field-hint"},"新用户创建时用户名的生成规则，修改后会同步到属性映射",-1))]),_:1}),m(De,{label:"自动注册"},{default:p(()=>[m(Ye,{modelValue:ie.value.imAutoRegister,"onUpdate:modelValue":i[11]||(i[11]=e=>ie.value.imAutoRegister=e)},null,8,["modelValue"]),i[68]||(i[68]=f("span",{class:"field-hint"},"同步时自动创建本地用户",-1))]),_:1}),m(De,{label:"默认角色"},{default:p(()=>[m(Ge,{modelValue:ie.value.imDefaultRoleId,"onUpdate:modelValue":i[12]||(i[12]=e=>ie.value.imDefaultRoleId=e),class:"full-width",clearable:"",placeholder:"新用户默认角色"},{default:p(()=>[(b(!0),r(k,null,I(de.value,e=>(b(),V(Je,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),m(Xe,{"content-position":"left"},{default:p(()=>[...i[69]||(i[69]=[y("SSO 免登",-1)])]),_:1}),"im_welink"!==ie.value.type?(b(),V(De,{key:2,label:"启用SSO"},{default:p(()=>[m(Ye,{modelValue:ie.value.imEnableSso,"onUpdate:modelValue":i[13]||(i[13]=e=>ie.value.imEnableSso=e)},null,8,["modelValue"]),i[70]||(i[70]=f("span",{class:"field-hint"},"允许用户通过该IM平台免登进入系统",-1))]),_:1})):U("",!0),ie.value.imEnableSso&&"im_welink"!==ie.value.type?(b(),V(De,{key:3,label:"SSO按钮文字"},{default:p(()=>[m(ge,{modelValue:ie.value.imSsoLabel,"onUpdate:modelValue":i[14]||(i[14]=e=>ie.value.imSsoLabel=e),placeholder:"如：钉钉登录"},null,8,["modelValue"])]),_:1})):U("",!0),ie.value.imEnableSso&&"im_welink"!==ie.value.type?(b(),V(De,{key:4,label:"SSO优先级"},{default:p(()=>[m(Ze,{modelValue:ie.value.imSsoPriority,"onUpdate:modelValue":i[15]||(i[15]=e=>ie.value.imSsoPriority=e),min:0,max:100},null,8,["modelValue"]),i[71]||(i[71]=f("span",{class:"field-hint"},"数字越大越靠前",-1))]),_:1})):U("",!0)],64)):U("",!0),"ldap_ad"===ie.value.type?(b(),r(k,{key:1},[m(Xe,{"content-position":"left"},{default:p(()=>[...i[72]||(i[72]=[y("连接参数",-1)])]),_:1}),m(De,{label:"服务器地址",required:""},{default:p(()=>[f("div",E,[m(ge,{modelValue:ie.value.host,"onUpdate:modelValue":i[16]||(i[16]=e=>ie.value.host=e),placeholder:"如：ldap.example.com",class:"addr-host"},null,8,["modelValue"]),m(Ze,{modelValue:ie.value.port,"onUpdate:modelValue":i[17]||(i[17]=e=>ie.value.port=e),min:1,max:65535,class:"addr-port"},null,8,["modelValue"])])]),_:1}),m(De,{label:"LDAPS (TLS)"},{default:p(()=>[m(Ye,{modelValue:ie.value.useTls,"onUpdate:modelValue":i[18]||(i[18]=e=>ie.value.useTls=e),onChange:me},null,8,["modelValue"]),i[73]||(i[73]=f("span",{class:"field-hint"},"启用SSL/TLS加密连接",-1))]),_:1}),m(De,{label:"Base DN",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.baseDn,"onUpdate:modelValue":i[19]||(i[19]=e=>ie.value.baseDn=e),placeholder:"dc=example,dc=com"},null,8,["modelValue"])]),_:1}),m(De,{label:"Bind DN",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.bindDn,"onUpdate:modelValue":i[20]||(i[20]=e=>ie.value.bindDn=e),placeholder:"cn=admin,dc=example,dc=com"},null,8,["modelValue"])]),_:1}),m(De,{label:"密码",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.bindPassword,"onUpdate:modelValue":i[21]||(i[21]=e=>ie.value.bindPassword=e),type:"password","show-password":"",placeholder:ae.value?"留空不修改":"绑定密码"},null,8,["modelValue","placeholder"])]),_:1}),m(De,{label:"用户过滤器"},{default:p(()=>[m(ge,{modelValue:ie.value.userFilter,"onUpdate:modelValue":i[22]||(i[22]=e=>ie.value.userFilter=e),placeholder:"如：(objectClass=person)"},null,8,["modelValue"]),i[74]||(i[74]=f("div",{class:"field-hint"},"LDAP搜索过滤器，留空则使用默认",-1))]),_:1}),m(De,{label:"UPN后缀"},{default:p(()=>[m(ge,{modelValue:ie.value.upnSuffix,"onUpdate:modelValue":i[23]||(i[23]=e=>ie.value.upnSuffix=e),placeholder:"@example.com"},null,8,["modelValue"])]),_:1})],64)):U("",!0),H(ie.value.type)?(b(),r(k,{key:2},[m(Xe,{"content-position":"left"},{default:p(()=>[...i[75]||(i[75]=[y("连接参数",-1)])]),_:1}),m(De,{label:"服务器地址",required:""},{default:p(()=>[f("div",F,[m(ge,{modelValue:ie.value.host,"onUpdate:modelValue":i[24]||(i[24]=e=>ie.value.host=e),placeholder:"如：192.168.1.100",class:"addr-host"},null,8,["modelValue"]),m(Ze,{modelValue:ie.value.port,"onUpdate:modelValue":i[25]||(i[25]=e=>ie.value.port=e),min:1,max:65535,class:"addr-port"},null,8,["modelValue"])])]),_:1}),m(De,{label:"db_oracle"===ie.value.type?"服务名":"数据库名",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.database,"onUpdate:modelValue":i[26]||(i[26]=e=>ie.value.database=e),placeholder:"数据库名称"},null,8,["modelValue"])]),_:1},8,["label"]),m(De,{label:"用户名",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.dbUser,"onUpdate:modelValue":i[27]||(i[27]=e=>ie.value.dbUser=e),placeholder:"数据库用户名"},null,8,["modelValue"])]),_:1}),m(De,{label:"密码",required:""},{default:p(()=>[m(ge,{modelValue:ie.value.dbPassword,"onUpdate:modelValue":i[28]||(i[28]=e=>ie.value.dbPassword=e),type:"password","show-password":"",placeholder:ae.value?"留空不修改":"数据库密码"},null,8,["modelValue","placeholder"])]),_:1}),m(De,{label:"用户表名"},{default:p(()=>[m(ge,{modelValue:ie.value.userTable,"onUpdate:modelValue":i[29]||(i[29]=e=>ie.value.userTable=e),placeholder:"如：users（存储用户数据的表名）"},null,8,["modelValue"])]),_:1}),m(De,{label:"字符集"},{default:p(()=>[m(ge,{modelValue:ie.value.charset,"onUpdate:modelValue":i[30]||(i[30]=e=>ie.value.charset=e),placeholder:"utf8mb4"},null,8,["modelValue"])]),_:1})],64)):U("",!0),n(ie.value.type)?U("",!0):(b(),r(k,{key:3},[m(Xe,{"content-position":"left"},{default:p(()=>[...i[76]||(i[76]=[y("同步配置",-1)])]),_:1}),m(De,{label:"自动注册"},{default:p(()=>[m(Ye,{modelValue:ie.value.imAutoRegister,"onUpdate:modelValue":i[31]||(i[31]=e=>ie.value.imAutoRegister=e)},null,8,["modelValue"]),i[77]||(i[77]=f("span",{class:"field-hint"},"同步时自动创建本地用户",-1))]),_:1}),m(De,{label:"用户匹配字段"},{default:p(()=>[m(Ge,{modelValue:ie.value.imMatchField,"onUpdate:modelValue":i[32]||(i[32]=e=>ie.value.imMatchField=e),class:"full-width"},{default:p(()=>[m(Je,{label:"用户名",value:"username"}),m(Je,{label:"手机号",value:"mobile"}),m(Je,{label:"邮箱",value:"email"})]),_:1},8,["modelValue"])]),_:1}),m(De,{label:"默认角色"},{default:p(()=>[m(Ge,{modelValue:ie.value.imDefaultRoleId,"onUpdate:modelValue":i[33]||(i[33]=e=>ie.value.imDefaultRoleId=e),class:"full-width",clearable:"",placeholder:"新用户默认角色"},{default:p(()=>[(b(!0),r(k,null,I(de.value,e=>(b(),V(Je,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})],64)),n(ie.value.type)?U("",!0):(b(),V(De,{key:4,label:"超时(秒)"},{default:p(()=>[m(Ze,{modelValue:ie.value.timeout,"onUpdate:modelValue":i[34]||(i[34]=e=>ie.value.timeout=e),min:1,max:60},null,8,["modelValue"])]),_:1}))]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),m(ll,{modelValue:he.value,"onUpdate:modelValue":i[49]||(i[49]=e=>he.value=e),title:ye.value?"编辑同步规则":"新增同步规则",width:"560px","destroy-on-close":""},{footer:p(()=>[m(c,{onClick:i[48]||(i[48]=e=>he.value=!1)},{default:p(()=>[...i[88]||(i[88]=[y("取消",-1)])]),_:1}),m(c,{type:"primary",onClick:Ae,loading:Ve.value},{default:p(()=>[...i[89]||(i[89]=[y("保存",-1)])]),_:1},8,["loading"])]),default:p(()=>[m(el,{model:we.value,"label-width":"110px"},{default:p(()=>[m(De,{label:"规则名称",required:""},{default:p(()=>[m(ge,{modelValue:we.value.name,"onUpdate:modelValue":i[37]||(i[37]=e=>we.value.name=e),placeholder:"如：钉钉全量同步 / LDAP用户导入"},null,8,["modelValue"])]),_:1}),m(De,{label:"上游连接器",required:""},{default:p(()=>[m(Ge,{modelValue:we.value.connectorId,"onUpdate:modelValue":i[38]||(i[38]=e=>we.value.connectorId=e),class:"full-width"},{default:p(()=>[(b(!0),r(k,null,I(Y.value,e=>(b(),V(Je,{key:e.id,label:e.name+" ("+K(e.type)+")",value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(Ue.value)?(b(),V(De,{key:0,label:"同步范围"},{default:p(()=>[m(Ge,{modelValue:we.value.scopeType,"onUpdate:modelValue":i[39]||(i[39]=e=>we.value.scopeType=e),class:"full-width"},{default:p(()=>[m(Je,{label:"全部部门",value:"all"}),m(Je,{label:"指定部门",value:"selected"})]),_:1},8,["modelValue"])]),_:1})):U("",!0),"selected"===we.value.scopeType&&n(Ue.value)?(b(),V(De,{key:1,label:"指定部门ID"},{default:p(()=>[m(ge,{modelValue:we.value.scopeDeptIds,"onUpdate:modelValue":i[40]||(i[40]=e=>we.value.scopeDeptIds=e),placeholder:"多个ID用逗号分隔"},null,8,["modelValue"])]),_:1})):U("",!0),m(Xe,{"content-position":"left"},{default:p(()=>[...i[80]||(i[80]=[y("定时同步",-1)])]),_:1}),m(De,{label:"定时同步"},{default:p(()=>[m(Ye,{modelValue:we.value.enableSchedule,"onUpdate:modelValue":i[41]||(i[41]=e=>we.value.enableSchedule=e)},null,8,["modelValue"])]),_:1}),we.value.enableSchedule?(b(),r(k,{key:2},[m(De,{label:"调度模式"},{default:p(()=>[m(tl,{modelValue:we.value.scheduleType,"onUpdate:modelValue":i[42]||(i[42]=e=>we.value.scheduleType=e)},{default:p(()=>[m(al,{value:"times"},{default:p(()=>[...i[81]||(i[81]=[y("定点时间",-1)])]),_:1}),m(al,{value:"interval"},{default:p(()=>[...i[82]||(i[82]=[y("固定间隔",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"times"===we.value.scheduleType?(b(),V(De,{key:0,label:"自动同步时间"},{default:p(()=>[f("div",N,[(b(!0),r(k,null,I(we.value.scheduleTimes,(e,l)=>(b(),r("div",{key:l,class:"schedule-time-row"},[m(ul,{modelValue:we.value.scheduleTimes[l],"onUpdate:modelValue":e=>we.value.scheduleTimes[l]=e,format:"HH:mm","value-format":"HH:mm",placeholder:"选择时间",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"]),m(c,{type:"danger",size:"small",onClick:e=>(e=>{we.value.scheduleTimes.splice(e,1)})(l)},{default:p(()=>[m(s,null,{default:p(()=>[m(h(a))]),_:1})]),_:1},8,["onClick"])]))),128)),m(c,{type:"primary",size:"small",onClick:ke},{default:p(()=>[m(s,null,{default:p(()=>[m(h(e))]),_:1})]),_:1})])]),_:1})):U("",!0),"interval"===we.value.scheduleType?(b(),V(De,{key:1,label:"同步间隔(分钟)"},{default:p(()=>[m(Ze,{modelValue:we.value.scheduleInterval,"onUpdate:modelValue":i[43]||(i[43]=e=>we.value.scheduleInterval=e),min:5,max:1440,step:5},null,8,["modelValue"])]),_:1})):U("",!0)],64)):U("",!0),H(Ue.value)?(b(),r(k,{key:3},[m(Xe,{"content-position":"left"},{default:p(()=>[...i[83]||(i[83]=[y("变更检测",-1)])]),_:1}),m(De,{label:"启用变更检测"},{default:p(()=>[m(Ye,{modelValue:we.value.enableChangeDetect,"onUpdate:modelValue":i[44]||(i[44]=e=>we.value.enableChangeDetect=e)},null,8,["modelValue"]),i[84]||(i[84]=f("span",{class:"field-hint"},"当数据库中的数据发生变更时自动触发同步",-1))]),_:1}),we.value.enableChangeDetect?(b(),r(k,{key:0},[m(De,{label:"检测间隔(秒)"},{default:p(()=>[m(Ze,{modelValue:we.value.changeDetectInterval,"onUpdate:modelValue":i[45]||(i[45]=e=>we.value.changeDetectInterval=e),min:10,max:3600,step:10},null,8,["modelValue"]),i[85]||(i[85]=f("span",{class:"field-hint"},"每隔多少秒检查一次数据库变更",-1))]),_:1}),m(De,{label:"变更字段"},{default:p(()=>[m(ge,{modelValue:we.value.changeDetectField,"onUpdate:modelValue":i[46]||(i[46]=e=>we.value.changeDetectField=e),placeholder:"如：updated_at / modify_time"},null,8,["modelValue"]),i[86]||(i[86]=f("div",{class:"field-hint"},"用于判断记录是否更新的时间戳字段名（数据库表中的列名）",-1))]),_:1})],64)):U("",!0)],64)):U("",!0),m(Xe,{"content-position":"left"},{default:p(()=>[...i[87]||(i[87]=[y("其他",-1)])]),_:1}),m(De,{label:"状态"},{default:p(()=>[m(Ye,{modelValue:we.value.statusBool,"onUpdate:modelValue":i[47]||(i[47]=e=>we.value.statusBool=e),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),m(ll,{modelValue:Te.value,"onUpdate:modelValue":i[51]||(i[51]=e=>Te.value=e),title:"属性映射配置",width:"860px","destroy-on-close":""},{footer:p(()=>[m(c,{onClick:i[50]||(i[50]=e=>Te.value=!1)},{default:p(()=>[...i[93]||(i[93]=[y("取消",-1)])]),_:1}),m(c,{type:"primary",onClick:He,loading:xe.value},{default:p(()=>[...i[94]||(i[94]=[y("保存映射",-1)])]),_:1},8,["loading"])]),default:p(()=>[f("div",O,[f("div",j,[f("span",B,"规则："+g(ze.value),1),m($,{size:"small",type:J(Pe.value),effect:"light",style:{"margin-left":"8px"}},{default:p(()=>[y(g(K(Pe.value)),1)]),_:1},8,["type"])]),f("div",W,[m(c,{size:"small",onClick:Qe},{default:p(()=>[m(s,null,{default:p(()=>[m(h(e))]),_:1}),i[90]||(i[90]=y(" 添加映射 ",-1))]),_:1}),m(c,{size:"small",type:"warning",onClick:Ke},{default:p(()=>[m(s,null,{default:p(()=>[m(h(l))]),_:1}),i[91]||(i[91]=y(" 恢复默认 ",-1))]),_:1})])]),m(dl,{type:"info",closable:!1,style:{"margin-bottom":"12px"}},{title:p(()=>[y(" 上游属性来源于"+g(n(Pe.value)?"IM平台":"ldap_ad"===Pe.value?"LDAP/AD目录":"数据库表")+'，目标属性为本地用户/群组字段。映射类型支持"直接映射"和"转换"两种模式。 ',1)]),_:1}),_((b(),V(oe,{data:qe.value,size:"small",stripe:"","max-height":"420"},{empty:p(()=>[m(te,{description:"暂无映射规则，点击【添加映射】或【恢复默认】","image-size":60})]),default:p(()=>[m(D,{label:"启用",width:"60",align:"center"},{default:p(({row:e})=>[m(Ye,{modelValue:e.isEnabled,"onUpdate:modelValue":l=>e.isEnabled=l,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{label:"对象",width:"100",align:"center"},{default:p(({row:e})=>[m(Ge,{modelValue:e.objectType,"onUpdate:modelValue":l=>e.objectType=l,size:"small"},{default:p(()=>[m(Je,{label:"用户",value:"user"}),m(Je,{label:"群组",value:"group"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{label:"上游属性（源）","min-width":"180"},{default:p(({row:e})=>[m(Ge,{modelValue:e.sourceAttribute,"onUpdate:modelValue":l=>e.sourceAttribute=l,size:"small",class:"full-width",filterable:"","allow-create":"",placeholder:"选择或输入"},{default:p(()=>{return[(b(!0),r(k,null,I((l=e.objectType,"group"===l?n(Pe.value)?Ne:Oe:n(Pe.value)?Le:"ldap_ad"===Pe.value?Ee:Fe),e=>(b(),V(Je,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))];var l}),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{width:"40",align:"center"},{default:p(()=>[...i[92]||(i[92]=[f("span",{style:{color:"var(--color-text-quaternary)","font-size":"16px"}},"→",-1)])]),_:1}),m(D,{label:"本地属性（目标）","min-width":"180"},{default:p(({row:e})=>[m(Ge,{modelValue:e.targetAttribute,"onUpdate:modelValue":l=>e.targetAttribute=l,size:"small",class:"full-width",filterable:"","allow-create":"",placeholder:"选择或输入"},{default:p(()=>{return[(b(!0),r(k,null,I((l=e.objectType,"group"===l?Be:je),e=>(b(),V(Je,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))];var l}),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{label:"类型",width:"110",align:"center"},{default:p(({row:e})=>[m(Ge,{modelValue:e.mappingType,"onUpdate:modelValue":l=>e.mappingType=l,size:"small"},{default:p(()=>[m(Je,{label:"直接映射",value:"mapping"}),m(Je,{label:"转换",value:"transform"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{label:"转换规则",width:"160"},{default:p(({row:e})=>["transform"===e.mappingType?(b(),V(Ge,{key:0,modelValue:e.transformRule,"onUpdate:modelValue":l=>e.transformRule=l,size:"small",class:"full-width",placeholder:"选择转换规则",clearable:""},{default:p(()=>[m(Je,{label:"中文转拼音（重名加数字）",value:"pinyin"}),m(Je,{label:"邮箱前缀",value:"email_prefix"}),m(Je,{label:"手机号",value:"mobile"}),m(Je,{label:"邮箱",value:"email"}),m(Je,{label:"IM平台UserID",value:"userid"})]),_:1},8,["modelValue","onUpdate:modelValue"])):(b(),r("span",Q,"-"))]),_:1}),m(D,{label:"优先级",width:"80",align:"center"},{default:p(({row:e})=>[m(Ze,{modelValue:e.priority,"onUpdate:modelValue":l=>e.priority=l,size:"small",min:0,max:100,"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),m(D,{label:"",width:"50",align:"center"},{default:p(({$index:e})=>[m(c,{type:"danger",link:"",size:"small",onClick:l=>{return a=e,void qe.value.splice(a,1);var a}},{default:p(()=>[m(s,null,{default:p(()=>[m(h(a))]),_:1})]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ol,Ce.value]])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-9a5197c0"]]);export{H as default};
