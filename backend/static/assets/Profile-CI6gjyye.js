import{v as a,k as e,D as s,G as l,H as d,U as o,S as t,M as n,R as r,aA as i,a6 as c,E as u,F as v,l as h,c as m,r as p,ac as w,aB as g,y as f,I as y}from"./vendor-DDTA3iPl.js";import{u as k,p as b,_ as V}from"./index-D9Oaf6TO.js";import{E as P}from"./elementPlus-DW6qdM9Z.js";const C={class:"profile-page"},z={class:"user-bar"},A={class:"user-bar-left"},I={class:"user-brief"},U={class:"user-name"},x={class:"user-detail"},_={class:"user-bar-right"},M={key:0,class:"pwd-time"},j={key:1,class:"pwd-time never"},H={class:"password-card"},B={class:"card-body"},L={class:"section"},D={class:"method-options"},E=["onClick"],N={key:0,class:"method-icon"},S={key:1,class:"method-icon"},T={key:2,class:"method-icon"},$={class:"form-body"},F={class:"form-grid"},G={key:0,class:"form-field"},O={key:1,class:"form-field"},R={class:"code-row"},Z={key:2,class:"form-field"},q={class:"code-row"},J={class:"field-hint"},K={class:"form-field"},Q={class:"form-field"},W=V(a({__name:"Profile",setup(a){const V=g(),W=k(),X=h({id:0,username:"",nickname:"",phone:"",email:"",avatar:"",source:"local",dingtalkUid:"",departmentName:"",jobTitle:"",roles:[],createdAt:"",lastLoginAt:"",lastLoginIp:"",passwordChangedAt:""}),Y=["#6366f1","#8b5cf6","#ec4899","#14b8a6","#f97316","#409eff","#67c23a","#e6a23c","#f56c6c","#909399"],aa=m(()=>{const a=X.nickname||X.username||"";return a?Y[a.charCodeAt(0)%Y.length]:Y[0]}),ea=m(()=>(X.nickname||X.username||"?").charAt(0).toUpperCase()),sa=m(()=>{const a=X.phone||"";return a.length>=7?a.substring(0,3)+"****"+a.substring(a.length-4):a}),la=m(()=>{const a=[{key:"password",name:"原密码验证"}],e=X.allowedVerifyMethods;return!X.dingtalkUid||e&&0!==e.length&&!e.includes("dingtalk")||a.push({key:"dingtalk",name:"钉钉验证码"}),!X.phone||e&&0!==e.length&&!e.includes("sms")||a.push({key:"sms",name:"短信验证码"}),a}),da=h({method:"password",oldPassword:"",code:"",newPassword:"",confirmPassword:""}),oa=p(!1),ta=p(!1),na=p(0),ra=p(0);let ia=null,ca=null;const ua=async a=>{var e;ta.value=!0;try{const s=await b.sendVerifyCode(a);s.data.success&&(P.success((null==(e=s.data.data)?void 0:e.message)||"验证码已发送"),"dingtalk"===a?(na.value=60,ia&&clearInterval(ia),ia=setInterval(()=>{--na.value<=0&&ia&&(clearInterval(ia),ia=null)},1e3)):(ra.value=60,ca&&clearInterval(ca),ca=setInterval(()=>{--ra.value<=0&&ca&&(clearInterval(ca),ca=null)},1e3)))}catch(s){}finally{ta.value=!1}},va=async()=>{if(!da.newPassword)return P.warning("请输入新密码");const a=(e=da.newPassword).length<8?"密码长度至少8位":e.length>128?"密码长度不能超过128位":/[A-Z]/.test(e)?/[a-z]/.test(e)?/[0-9]/.test(e)?null:"密码必须包含数字":"密码必须包含小写字母":"密码必须包含大写字母";var e;if(a)return P.warning(a);if(da.newPassword!==da.confirmPassword)return P.warning("两次输入的密码不一致");if("password"===da.method&&!da.oldPassword)return P.warning("请输入原密码");if("password"!==da.method&&!da.code)return P.warning("请输入验证码");oa.value=!0;try{(await b.changePassword({method:da.method,oldPassword:"password"===da.method?da.oldPassword:void 0,code:"password"!==da.method?da.code:void 0,newPassword:da.newPassword})).data.success&&(P.success("密码修改成功，即将返回登录页..."),setTimeout(async()=>{await W.logout(),V.push("/login")},1500))}catch(s){}finally{oa.value=!1}},ha=async()=>{await W.logout(),V.push("/login")};return e(()=>(async()=>{try{const a=await b.get();a.data.success&&a.data.data&&Object.assign(X,a.data.data)}catch(a){}})()),(a,e)=>{const h=w("el-input"),m=w("el-button");return f(),s("div",C,[l("div",z,[l("div",A,[l("div",{class:"avatar",style:d({background:aa.value})},o(ea.value),5),l("div",I,[l("span",U,o(X.nickname||X.username),1),l("span",x,[t(o(X.username)+" ",1),X.phone?(f(),s(n,{key:0},[t(" · "+o(X.phone),1)],64)):r("",!0),X.email?(f(),s(n,{key:1},[t(" · "+o(X.email),1)],64)):r("",!0)])])]),l("div",_,[X.passwordChangedAt?(f(),s("span",M," 上次修改密码："+o((p=X.passwordChangedAt,p?new Date(p).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"")),1)):(f(),s("span",j,"从未修改过密码")),l("button",{class:"logout-btn",onClick:ha},"退出登录")])]),l("div",H,[e[19]||(e[19]=i('<div class="card-header" data-v-c69ac8f2><div class="card-icon" data-v-c69ac8f2><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" data-v-c69ac8f2><rect x="3" y="11" width="18" height="11" rx="2" ry="2" data-v-c69ac8f2></rect><path d="M7 11V7a5 5 0 0 1 10 0v4" data-v-c69ac8f2></path></svg></div><div data-v-c69ac8f2><div class="card-title" data-v-c69ac8f2>修改登录密码</div><div class="card-desc" data-v-c69ac8f2>定期更换密码有助于保护账户安全</div></div></div>',1)),l("div",B,[l("div",L,[e[10]||(e[10]=l("div",{class:"section-label"},"验证身份",-1)),l("div",D,[(f(!0),s(n,null,c(la.value,a=>(f(),s("button",{key:a.key,class:y(["method-btn",{active:da.method===a.key}]),onClick:e=>{return s=a.key,da.method=s,da.oldPassword="",void(da.code="");var s}},["password"===a.key?(f(),s("span",N,[...e[7]||(e[7]=[l("svg",{viewBox:"0 0 20 20",fill:"currentColor",width:"16",height:"16"},[l("path",{"fill-rule":"evenodd",d:"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z","clip-rule":"evenodd"})],-1)])])):"dingtalk"===a.key?(f(),s("span",S,[...e[8]||(e[8]=[l("svg",{viewBox:"0 0 20 20",fill:"currentColor",width:"16",height:"16"},[l("path",{d:"M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"}),l("path",{d:"M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"})],-1)])])):(f(),s("span",T,[...e[9]||(e[9]=[l("svg",{viewBox:"0 0 20 20",fill:"currentColor",width:"16",height:"16"},[l("path",{d:"M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"})],-1)])])),t(" "+o(a.name),1)],10,E))),128))])]),e[18]||(e[18]=l("div",{class:"form-divider"},null,-1)),l("div",$,[l("div",F,["password"===da.method?(f(),s("div",G,[e[11]||(e[11]=l("label",{class:"field-label"},"原密码",-1)),u(h,{modelValue:da.oldPassword,"onUpdate:modelValue":e[0]||(e[0]=a=>da.oldPassword=a),type:"password","show-password":"",placeholder:"请输入当前密码",size:"large"},null,8,["modelValue"])])):r("",!0),"dingtalk"===da.method?(f(),s("div",O,[e[12]||(e[12]=l("label",{class:"field-label"},"钉钉验证码",-1)),l("div",R,[u(h,{modelValue:da.code,"onUpdate:modelValue":e[1]||(e[1]=a=>da.code=a),placeholder:"请输入6位验证码",size:"large"},null,8,["modelValue"]),u(m,{size:"large",class:"code-btn",onClick:e[2]||(e[2]=a=>ua("dingtalk")),disabled:na.value>0,loading:ta.value},{default:v(()=>[t(o(na.value>0?`${na.value}s`:"获取验证码"),1)]),_:1},8,["disabled","loading"])]),e[13]||(e[13]=l("span",{class:"field-hint"},"验证码将通过钉钉工作通知发送",-1))])):r("",!0),"sms"===da.method?(f(),s("div",Z,[e[14]||(e[14]=l("label",{class:"field-label"},"短信验证码",-1)),l("div",q,[u(h,{modelValue:da.code,"onUpdate:modelValue":e[3]||(e[3]=a=>da.code=a),placeholder:"请输入6位验证码",size:"large"},null,8,["modelValue"]),u(m,{size:"large",class:"code-btn",onClick:e[4]||(e[4]=a=>ua("sms")),disabled:ra.value>0,loading:ta.value},{default:v(()=>[t(o(ra.value>0?`${ra.value}s`:"获取验证码"),1)]),_:1},8,["disabled","loading"])]),l("span",J,"验证码将发送至 "+o(sa.value),1)])):r("",!0),l("div",K,[e[15]||(e[15]=l("label",{class:"field-label"},"新密码",-1)),u(h,{modelValue:da.newPassword,"onUpdate:modelValue":e[5]||(e[5]=a=>da.newPassword=a),type:"password","show-password":"",placeholder:"至少8位，需包含大小写字母和数字",size:"large"},null,8,["modelValue"])]),l("div",Q,[e[16]||(e[16]=l("label",{class:"field-label"},"确认新密码",-1)),u(h,{modelValue:da.confirmPassword,"onUpdate:modelValue":e[6]||(e[6]=a=>da.confirmPassword=a),type:"password","show-password":"",placeholder:"再次输入新密码",size:"large"},null,8,["modelValue"])])]),u(m,{type:"primary",size:"large",class:"submit-btn",onClick:va,loading:oa.value},{default:v(()=>[...e[17]||(e[17]=[t("确认修改",-1)])]),_:1},8,["loading"])])])])]);var p}}}),[["__scopeId","data-v-c69ac8f2"]]);export{W as default};
