import{r as e,j as l,g as a,_ as t}from"./index-D9Oaf6TO.js";import{E as d,K as u}from"./elementPlus-DW6qdM9Z.js";import{v as o,k as s,D as i,E as n,F as r,r as c,ac as p,y as v,P as m,z as y,S as f,U as g,G as h,R as b,M as k,a6 as V,l as _,ad as w}from"./vendor-DDTA3iPl.js";const x={class:"roles-page"},C={class:"toolbar"},U={class:"layout-hint"},T={class:"role-rule-header"},M={key:0,style:{color:"#c0c4cc","font-size":"13px",padding:"8px 0"}},P={key:0,class:"apply-result",style:{"margin-top":"16px"}},z={key:0,style:{"margin-top":"8px"}},A={style:{"margin-left":"8px"}},j={style:{display:"flex","justify-content":"space-between",width:"100%"}},I=t(o({__name:"Roles",setup(t){const o=c(!1),I=c([]),R=c([]),$=c([]),E=c(!1),K=c(!1),S=c(0),B=_({name:"",code:"",description:""}),D=c(!1),N=c(0),O=c(),F=async()=>{o.value=!0;try{const l=await e.list();l.data.success&&(I.value=l.data.data||[])}catch(l){}finally{o.value=!1}},G=()=>{K.value=!1,S.value=0,Object.assign(B,{name:"",code:"",description:""}),E.value=!0},H=async()=>{if(B.name)try{if(K.value)await e.update(S.value,B),d.success("保存成功");else{if(!B.code)return void d.warning("请输入角色编码");await e.create(B),d.success("创建成功")}E.value=!1,F()}catch(l){}else d.warning("请输入角色名称")},q=async l=>{N.value=l.id;try{const a=await e.getPermissions(l.id);if(a.data.success){const e=((e,l)=>{const a=new Set,t=e=>{for(const l of e)l.children&&l.children.length>0&&(a.add(l.id),t(l.children))};return t(l),e.filter(e=>!a.has(e))})(a.data.data||[],R.value);D.value=!0,setTimeout(()=>{var l;null==(l=O.value)||l.setCheckedKeys(e,!1)},100)}}catch(a){}},J=async()=>{var l,a;const t=[...null==(l=O.value)?void 0:l.getCheckedKeys(!1),...null==(a=O.value)?void 0:a.getHalfCheckedKeys()];try{await e.updatePermissions(N.value,t),d.success("权限分配成功"),D.value=!1}catch(u){}},L=c(!1),Q=c(!1),W=c(0),X=_({sidebarMode:"auto",landingPage:""}),Y=async()=>{Q.value=!0;try{const l=I.value.find(e=>e.id===W.value);await e.update(W.value,{name:(null==l?void 0:l.name)||"",description:(null==l?void 0:l.description)||"",sidebarMode:X.sidebarMode,landingPage:X.landingPage}),d.success("布局配置保存成功"),L.value=!1,F()}catch(l){d.error("保存失败")}finally{Q.value=!1}},Z=c(!1),ee=c(!1),le=c([]),ae=c([]),te=async()=>{await(async()=>{try{const e=await a.list();e.data.success&&($.value=e.data.data.groups||[],ae.value=(e=>{const l={},a=[];return e.forEach(e=>{l[e.id]={...e,children:[]}}),e.forEach(e=>{const t=l[e.id];e.parentId&&0!==e.parentId&&l[e.parentId]?l[e.parentId].children.push(t):a.push(t)}),1===a.length&&a[0].children.length>0?a[0].children:a})($.value))}catch(e){}})();const l=[];for(const a of I.value)try{const t=await e.getAutoAssignRules(a.id),d=(t.data.success?t.data.data:[])||[];l.push({id:a.id,name:a.name,rules:d.map(e=>({ruleType:e.ruleType,ruleValue:"group"===e.ruleType?Number(e.ruleValue):e.ruleValue}))})}catch(t){l.push({id:a.id,name:a.name,rules:[]})}le.value=l,ue.value=null,Z.value=!0},de=c(!1),ue=c(null),oe=async()=>{ee.value=!0;try{for(const l of le.value){const a=l.rules.filter(e=>e.ruleType&&e.ruleValue).map(e=>({ruleType:e.ruleType,ruleValue:String(e.ruleValue)}));await e.updateAutoAssignRules(l.id,a)}d.success("规则保存成功"),Z.value=!1,ue.value=null}catch(l){d.error("保存失败")}finally{ee.value=!1}},se=async()=>{try{await u.confirm("将根据已保存的规则，立即为所有匹配的已有用户分配对应角色。是否继续？","立即执行自动分配",{confirmButtonText:"执行",cancelButtonText:"取消",type:"warning"})}catch{return}de.value=!0,ue.value=null;try{const l=await e.applyAutoAssignRules();l.data.success&&(ue.value=l.data.data,l.data.data.totalAssigned>0?d.success(`成功为 ${l.data.data.totalAssigned} 名用户分配了角色`):d.info("所有匹配用户已拥有对应角色，无需新分配"))}catch(l){d.error("执行失败")}finally{de.value=!1}};return s(()=>{F(),(async()=>{try{const e=await l.tree();e.data.success&&(R.value=e.data.data||[])}catch(e){}})()}),(l,a)=>{const t=p("el-button"),s=p("el-table-column"),c=p("el-tag"),_=p("el-table"),$=p("el-card"),N=p("el-input"),ie=p("el-form-item"),ne=p("el-form"),re=p("el-dialog"),ce=p("el-alert"),pe=p("el-radio-button"),ve=p("el-radio-group"),me=p("el-option"),ye=p("el-select"),fe=p("el-tree"),ge=p("el-tree-select"),he=w("loading");return v(),i("div",x,[n($,null,{header:r(()=>[h("div",C,[n(t,{type:"success",onClick:G},{default:r(()=>[...a[13]||(a[13]=[f("新增角色",-1)])]),_:1}),n(t,{onClick:te},{default:r(()=>[...a[14]||(a[14]=[f("设置",-1)])]),_:1})])]),default:r(()=>[m((v(),y(_,{data:I.value},{default:r(()=>[n(s,{prop:"id",label:"ID",width:"80"}),n(s,{prop:"name",label:"角色名称",width:"150"}),n(s,{prop:"code",label:"角色编码",width:"150"}),n(s,{prop:"description",label:"描述"}),n(s,{label:"状态",width:"80"},{default:r(({row:e})=>[n(c,{type:1===e.status?"success":"danger"},{default:r(()=>[f(g(1===e.status?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),n(s,{label:"操作",width:"280"},{default:r(({row:l})=>[n(t,{type:"primary",link:"",onClick:e=>{return a=l,K.value=!0,S.value=a.id,Object.assign(B,{name:a.name,code:a.code,description:a.description}),void(E.value=!0);var a}},{default:r(()=>[...a[15]||(a[15]=[f("编辑",-1)])]),_:1},8,["onClick"]),n(t,{type:"success",link:"",onClick:e=>q(l)},{default:r(()=>[...a[16]||(a[16]=[f("权限",-1)])]),_:1},8,["onClick"]),n(t,{type:"warning",link:"",onClick:e=>{return a=l,W.value=a.id,X.sidebarMode=a.sidebarMode||"auto",X.landingPage=a.landingPage||"",void(L.value=!0);var a}},{default:r(()=>[...a[17]||(a[17]=[f("布局",-1)])]),_:1},8,["onClick"]),n(t,{type:"danger",link:"",onClick:a=>(async l=>{try{await u.confirm(`确定删除角色 ${l.name}？`,"提示"),await e.delete(l.id),d.success("删除成功"),F()}catch(a){}})(l)},{default:r(()=>[...a[18]||(a[18]=[f("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,o.value]])]),_:1}),n(re,{modelValue:E.value,"onUpdate:modelValue":a[4]||(a[4]=e=>E.value=e),title:K.value?"编辑角色":"新增角色",width:"500px"},{footer:r(()=>[n(t,{onClick:a[3]||(a[3]=e=>E.value=!1)},{default:r(()=>[...a[19]||(a[19]=[f("取消",-1)])]),_:1}),n(t,{type:"primary",onClick:H},{default:r(()=>[...a[20]||(a[20]=[f("保存",-1)])]),_:1})]),default:r(()=>[n(ne,{model:B,"label-width":"80px"},{default:r(()=>[n(ie,{label:"角色名称"},{default:r(()=>[n(N,{modelValue:B.name,"onUpdate:modelValue":a[0]||(a[0]=e=>B.name=e)},null,8,["modelValue"])]),_:1}),K.value?b("",!0):(v(),y(ie,{key:0,label:"角色编码"},{default:r(()=>[n(N,{modelValue:B.code,"onUpdate:modelValue":a[1]||(a[1]=e=>B.code=e)},null,8,["modelValue"])]),_:1})),n(ie,{label:"描述"},{default:r(()=>[n(N,{modelValue:B.description,"onUpdate:modelValue":a[2]||(a[2]=e=>B.description=e),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(re,{modelValue:L.value,"onUpdate:modelValue":a[8]||(a[8]=e=>L.value=e),title:"页面布局配置",width:"500px","destroy-on-close":""},{footer:r(()=>[n(t,{onClick:a[7]||(a[7]=e=>L.value=!1)},{default:r(()=>[...a[26]||(a[26]=[f("取消",-1)])]),_:1}),n(t,{type:"primary",onClick:Y,loading:Q.value},{default:r(()=>[...a[27]||(a[27]=[f("保存",-1)])]),_:1},8,["loading"])]),default:r(()=>[n(ce,{type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:r(()=>[...a[21]||(a[21]=[f(" 配置该角色用户登录后的页面布局和默认首页。当用户拥有多个角色时，取最严格的配置。 ",-1)])]),_:1}),n(ne,{model:X,"label-width":"100px"},{default:r(()=>[n(ie,{label:"侧边栏"},{default:r(()=>[n(ve,{modelValue:X.sidebarMode,"onUpdate:modelValue":a[5]||(a[5]=e=>X.sidebarMode=e)},{default:r(()=>[n(pe,{value:"auto"},{default:r(()=>[...a[22]||(a[22]=[f("自动",-1)])]),_:1}),n(pe,{value:"visible"},{default:r(()=>[...a[23]||(a[23]=[f("始终显示",-1)])]),_:1}),n(pe,{value:"hidden"},{default:r(()=>[...a[24]||(a[24]=[f("始终隐藏",-1)])]),_:1})]),_:1},8,["modelValue"]),h("div",U,["auto"===X.sidebarMode?(v(),i(k,{key:0},[f("根据可访问菜单数量自动判断：仅1个菜单时隐藏")],64)):"hidden"===X.sidebarMode?(v(),i(k,{key:1},[f("隐藏侧边栏，用户仅看到内容区域")],64)):(v(),i(k,{key:2},[f("始终显示侧边栏导航")],64))])]),_:1}),n(ie,{label:"默认首页"},{default:r(()=>[n(ye,{modelValue:X.landingPage,"onUpdate:modelValue":a[6]||(a[6]=e=>X.landingPage=e),style:{width:"100%"},placeholder:"自动检测（按权限跳转）",clearable:""},{default:r(()=>[n(me,{label:"自动检测",value:""}),n(me,{label:"用户管理",value:"/admin/users/local"}),n(me,{label:"角色管理",value:"/admin/roles"}),n(me,{label:"登录日志",value:"/admin/logs/login"}),n(me,{label:"操作日志",value:"/admin/logs/operation"}),n(me,{label:"个人中心",value:"/admin/profile"}),n(me,{label:"系统首页",value:"/admin"})]),_:1},8,["modelValue"]),a[25]||(a[25]=h("div",{class:"layout-hint"},"该角色用户登录后默认打开的页面，留空则根据权限自动跳转",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),n(re,{modelValue:D.value,"onUpdate:modelValue":a[10]||(a[10]=e=>D.value=e),title:"分配权限",width:"500px"},{footer:r(()=>[n(t,{onClick:a[9]||(a[9]=e=>D.value=!1)},{default:r(()=>[...a[28]||(a[28]=[f("取消",-1)])]),_:1}),n(t,{type:"primary",onClick:J},{default:r(()=>[...a[29]||(a[29]=[f("保存",-1)])]),_:1})]),default:r(()=>[n(fe,{ref_key:"treeRef",ref:O,data:R.value,props:{label:"name",children:"children"},"show-checkbox":"","node-key":"id","default-expand-all":""},null,8,["data"])]),_:1},8,["modelValue"]),n(re,{modelValue:Z.value,"onUpdate:modelValue":a[12]||(a[12]=e=>Z.value=e),title:"角色自动分配规则",width:"650px","destroy-on-close":""},{footer:r(()=>[h("div",j,[n(t,{type:"warning",onClick:se,loading:de.value},{default:r(()=>[...a[32]||(a[32]=[f("立即执行",-1)])]),_:1},8,["loading"]),h("div",null,[n(t,{onClick:a[11]||(a[11]=e=>Z.value=!1)},{default:r(()=>[...a[33]||(a[33]=[f("取消",-1)])]),_:1}),n(t,{type:"primary",onClick:oe,loading:ee.value},{default:r(()=>[...a[34]||(a[34]=[f("保存",-1)])]),_:1},8,["loading"])])])]),default:r(()=>[a[35]||(a[35]=h("div",{class:"auto-assign-tip",style:{"margin-bottom":"16px",color:"var(--color-text-tertiary)","font-size":"13px"}},' 配置规则后点击"保存"仅保存规则；点击"立即执行"可将已保存的规则应用到所有匹配的已有用户。钉钉同步时也会自动应用。 ',-1)),(v(!0),i(k,null,V(le.value,(e,l)=>(v(),i("div",{key:e.id,class:"role-rule-section"},[h("div",T,[n(c,{type:"primary",effect:"dark"},{default:r(()=>[f(g(e.name),1)]),_:2},1024),n(t,{type:"primary",link:"",size:"small",onClick:e=>{return a=l,void le.value[a].rules.push({ruleType:"group",ruleValue:""});var a}},{default:r(()=>[...a[30]||(a[30]=[f("+ 添加规则",-1)])]),_:1},8,["onClick"])]),0===e.rules.length?(v(),i("div",M," 暂无规则 ")):b("",!0),(v(!0),i(k,null,V(e.rules,(e,d)=>(v(),i("div",{key:d,class:"rule-row"},[n(ye,{modelValue:e.ruleType,"onUpdate:modelValue":l=>e.ruleType=l,placeholder:"条件类型",style:{width:"120px"},size:"small"},{default:r(()=>[n(me,{label:"群组",value:"group"}),n(me,{label:"岗位",value:"job_title"})]),_:1},8,["modelValue","onUpdate:modelValue"]),"group"===e.ruleType?(v(),y(ge,{key:0,modelValue:e.ruleValue,"onUpdate:modelValue":l=>e.ruleValue=l,data:ae.value,props:{children:"children",label:"name",value:"id"},placeholder:"选择群组",clearable:"","check-strictly":"",size:"small",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue","data"])):(v(),y(N,{key:1,modelValue:e.ruleValue,"onUpdate:modelValue":l=>e.ruleValue=l,placeholder:"输入岗位名称（精确匹配）",size:"small",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"])),n(t,{type:"danger",link:"",size:"small",onClick:e=>{return a=l,t=d,void le.value[a].rules.splice(t,1);var a,t}},{default:r(()=>[...a[31]||(a[31]=[f("删除",-1)])]),_:1},8,["onClick"])]))),128))]))),128)),ue.value?(v(),i("div",P,[n(ce,{title:`执行完成：匹配 ${ue.value.totalMatched} 人，新分配 ${ue.value.totalAssigned} 人，已有角色跳过 ${ue.value.totalSkipped} 人`,type:ue.value.totalAssigned>0?"success":"info","show-icon":"",closable:!1},null,8,["title","type"]),ue.value.details&&ue.value.details.length>0?(v(),i("div",z,[(v(!0),i(k,null,V(ue.value.details,e=>(v(),i("div",{key:e.roleId,style:{"font-size":"13px",color:"var(--color-text-secondary)",padding:"4px 0"}},[n(c,{size:"small",type:"primary"},{default:r(()=>[f(g(e.roleName),1)]),_:2},1024),h("span",A,"匹配 "+g(e.matched)+" 人，新分配 "+g(e.assigned)+" 人，跳过 "+g(e.skipped)+" 人",1)]))),128))])):b("",!0)])):b("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-f7be8aa6"]]);export{I as default};
