import{k as e,g as l,f as a,_ as t}from"./index-D9Oaf6TO.js";import{E as s}from"./elementPlus-DW6qdM9Z.js";import{v as n,k as d,D as i,E as o,F as u,r as c,ac as r,y as p,G as m,S as v,P as y,z as f,U as h,M as _,a6 as g,l as b,ad as w}from"./vendor-DDTA3iPl.js";const V={class:"notify-page"},I={class:"tab-header"},k={class:"scene-name"},T={class:"scene-code"},A={class:"tab-header"},z={class:"scene-name"},U={class:"tab-header"},x={key:0,class:"text-muted"},C={key:0},N={key:1,class:"text-muted"},M={key:0,class:"form-hint-block"},P={key:1,class:"form-hint-block"},G={class:"severity-legend"},j={class:"severity-item"},q={class:"severity-item"},L={class:"severity-item"},R={class:"severity-item"},O=t(n({__name:"NotifyRules",setup(t){const n=c("policies"),O=c([]),$=c([]),E=c(!1),D=c(!1),F=[{scene:"verify_code",sceneName:"验证码通知"},{scene:"password_reset",sceneName:"密码重置验证"},{scene:"password_reset_notify",sceneName:"密码被重置通知"},{scene:"account_created",sceneName:"账号开通通知"},{scene:"test",sceneName:"测试消息"}],S=c([]),W=async()=>{E.value=!0;try{const l=await e.getPolicies(),a=(l.data.success&&l.data.data||[]).filter(e=>!e.targetType||"all"===e.targetType);S.value=F.map(e=>{const l=a.find(l=>l.scene===e.scene);return{scene:e.scene,sceneName:e.sceneName,channelIds:(null==l?void 0:l.channelIdList)||(null==l?void 0:l.channelIds)||[],isActive:!l||l.isActive}})}finally{E.value=!1}},B=async()=>{D.value=!0;try{await e.batchUpdatePolicies(S.value),s.success("默认策略已保存"),W()}catch{s.error("保存失败")}finally{D.value=!1}},H=c([]),J=c({}),K=c([]),Q=c(!1),X=c(!1),Y=c(!1),Z=c(null),ee=b({scene:"password_reset_notify",targetGroupIds:[],channelIds:[],isActive:!0}),le=e=>{const l={},a=[];for(const t of e)l[t.id]={...t,children:[]};for(const t of e){const e=l[t.id];t.parentId&&l[t.parentId]?l[t.parentId].children.push(e):a.push(e)}return a},ae=async()=>{Q.value=!0;try{const l=await e.getPolicies(),a=l.data.success&&l.data.data||[];K.value=a.filter(e=>"group"===e.targetType)}finally{Q.value=!1}},te=e=>J.value[e]||`群组#${e}`,se=e=>{const l=O.value.find(l=>l.id===e);return l?l.name:`渠道#${e}`},ne=e=>{const l=F.find(l=>l.scene===e);return l?l.sceneName:e},de=e=>{e?(Z.value=e.id,Object.assign(ee,{scene:e.scene,targetGroupIds:e.groupIdList||[],channelIds:e.channelIdList||[],isActive:e.isActive})):(Z.value=null,Object.assign(ee,{scene:"password_reset_notify",targetGroupIds:[],channelIds:[],isActive:!0})),X.value=!0},ie=async()=>{if(0!==ee.targetGroupIds.length)if(0!==ee.channelIds.length){Y.value=!0;try{const e=ne(ee.scene),l={scene:ee.scene,sceneName:e,channelIds:ee.channelIds,targetGroupIds:ee.targetGroupIds,isActive:ee.isActive};Z.value?await a.put(`/notify/policies/group/${Z.value}`,l):await a.post("/notify/policies/group",l),s.success("群组策略已保存"),X.value=!1,ae()}catch{s.error("保存失败")}finally{Y.value=!1}}else s.warning("请选择通知通道");else s.warning("请选择适用群组")},oe=c(!1),ue=c(!1),ce=c([]),re=c(!1),pe=c(null),me=b({alertType:"admin",name:"",eventTypes:[],severityThreshold:"high",channelIds:[],templateId:0,cooldownMinutes:30,isActive:!0}),ve={low:{name:"低",type:"info"},medium:{name:"中",type:"warning"},high:{name:"高",type:"danger"},critical:{name:"严重",type:"danger"}},ye={login_success:"登录成功",login_failed:"登录失败",login_blocked:"登录阻止",account_locked:"账户锁定",ip_blocked:"IP封禁",password_changed:"密码修改",config_changed:"配置变更",suspicious_activity:"可疑活动",session_terminated:"会话终止"},fe=e=>{var l;return(null==(l=ve[e])?void 0:l.name)||e},he=async()=>{oe.value=!0;try{const l=await e.alertRules();l.data.success&&(ce.value=l.data.data||[])}finally{oe.value=!1}},_e=()=>{pe.value=null,Object.assign(me,{alertType:"admin",name:"",eventTypes:[],severityThreshold:"high",channelIds:[],templateId:0,cooldownMinutes:30,isActive:!0}),re.value=!0},ge=async()=>{if(me.name)if(0!==me.channelIds.length){ue.value=!0;try{const l={alertType:me.alertType,name:me.name,eventTypes:me.eventTypes,severityThreshold:me.severityThreshold,notifyChannels:me.channelIds,notifyTarget:"employee"===me.alertType?"event_user":"channel",templateId:me.templateId,cooldownMinutes:me.cooldownMinutes,isActive:me.isActive};pe.value?await e.updateAlertRule(pe.value,l):await e.createAlertRule(l),s.success("保存成功"),re.value=!1,he()}finally{ue.value=!1}}else s.warning("请选择通知渠道");else s.warning("请输入规则名称")};return d(()=>{(async()=>{try{const l=await e.notifyChannels();l.data.success&&(O.value=(l.data.data||[]).filter(e=>e.isActive))}catch{}})(),(async()=>{try{const l=await e.getTemplates();l.data.success&&($.value=l.data.data||[])}catch{}})(),W(),ae(),(async()=>{var e;try{const a=await l.list();if(a.data.success){const l=a.data.data,t=(null==l?void 0:l.groups)||l||[],s=le(t);1===s.length&&(null==(e=s[0].children)?void 0:e.length)>0?H.value=s[0].children:H.value=s;const n={},d=e=>{var l;for(const a of e)n[a.id]=a.name,(null==(l=a.children)?void 0:l.length)&&d(a.children)};d(t),J.value=n}}catch{}})(),he()}),(l,t)=>{const d=r("el-button"),c=r("el-table-column"),b=r("el-option"),W=r("el-select"),J=r("el-switch"),le=r("el-table"),be=r("el-tag"),we=r("el-popconfirm"),Ve=r("el-empty"),Ie=r("el-tab-pane"),ke=r("el-tabs"),Te=r("el-radio-button"),Ae=r("el-radio-group"),ze=r("el-form-item"),Ue=r("el-input"),xe=r("el-input-number"),Ce=r("el-form"),Ne=r("el-dialog"),Me=r("el-tree-select"),Pe=w("loading");return p(),i("div",V,[o(ke,{modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value=e),type:"border-card"},{default:u(()=>[o(Ie,{label:"消息策略",name:"policies"},{default:u(()=>[m("div",I,[t[19]||(t[19]=m("span",{class:"tab-desc"},"配置每种消息场景默认使用的通知通道（适用于所有用户）",-1)),o(d,{type:"primary",size:"small",onClick:B,loading:D.value},{default:u(()=>[...t[18]||(t[18]=[v("保存默认策略",-1)])]),_:1},8,["loading"])]),y((p(),f(le,{data:S.value,stripe:"",size:"small"},{default:u(()=>[o(c,{prop:"sceneName",label:"消息场景",width:"200"},{default:u(({row:e})=>[m("span",k,h(e.sceneName),1)]),_:1}),o(c,{prop:"scene",label:"场景标识",width:"180"},{default:u(({row:e})=>[m("code",T,h(e.scene),1)]),_:1}),o(c,{label:"通知通道","min-width":"300"},{default:u(({row:e})=>[o(W,{modelValue:e.channelIds,"onUpdate:modelValue":l=>e.channelIds=l,multiple:"",placeholder:"选择通知通道",style:{width:"100%"},size:"small"},{default:u(()=>[(p(!0),i(_,null,g(O.value,e=>(p(),f(b,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),o(c,{label:"启用",width:"80",align:"center"},{default:u(({row:e})=>[o(J,{modelValue:e.isActive,"onUpdate:modelValue":l=>e.isActive=l,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"])),[[Pe,E.value]]),t[24]||(t[24]=m("div",{class:"section-divider"},null,-1)),m("div",A,[t[21]||(t[21]=m("div",null,[m("span",{class:"tab-desc",style:{"font-weight":"500","font-size":"15px",color:"var(--color-text-primary)"}},"群组专属策略"),m("div",{class:"tab-desc",style:{"margin-top":"4px"}},"为特定群组（如外部人员）设置独立的通知通道，优先级高于默认策略")],-1)),o(d,{type:"primary",size:"small",onClick:t[0]||(t[0]=e=>de())},{default:u(()=>[...t[20]||(t[20]=[v("添加群组策略",-1)])]),_:1})]),K.value.length>0?y((p(),f(le,{key:0,data:K.value,stripe:"",size:"small"},{default:u(()=>[o(c,{label:"消息场景",width:"200"},{default:u(({row:e})=>[m("span",z,h(e.sceneName||ne(e.scene)),1)]),_:1}),o(c,{label:"适用群组","min-width":"200"},{default:u(({row:e})=>[(p(!0),i(_,null,g(e.groupIdList||[],e=>(p(),f(be,{key:e,size:"small",style:{"margin-right":"4px"}},{default:u(()=>[v(h(te(e)),1)]),_:2},1024))),128))]),_:1}),o(c,{label:"通知通道","min-width":"200"},{default:u(({row:e})=>[(p(!0),i(_,null,g(e.channelIdList||[],e=>(p(),f(be,{key:e,type:"success",size:"small",style:{"margin-right":"4px"}},{default:u(()=>[v(h(se(e)),1)]),_:2},1024))),128))]),_:1}),o(c,{label:"启用",width:"80",align:"center"},{default:u(({row:e})=>[o(be,{type:e.isActive?"success":"info",size:"small"},{default:u(()=>[v(h(e.isActive?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),o(c,{label:"操作",width:"120",fixed:"right"},{default:u(({row:e})=>[o(d,{type:"primary",link:"",size:"small",onClick:l=>(e=>de(e))(e)},{default:u(()=>[...t[22]||(t[22]=[v("编辑",-1)])]),_:1},8,["onClick"]),o(we,{title:"确定删除此群组策略?",onConfirm:l=>(async e=>{try{await a.delete(`/notify/policies/group/${e}`),s.success("已删除"),ae()}catch{s.error("删除失败")}})(e.id)},{reference:u(()=>[o(d,{type:"danger",link:"",size:"small"},{default:u(()=>[...t[23]||(t[23]=[v("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[Pe,Q.value]]):(p(),f(Ve,{key:1,description:"暂无群组专属策略","image-size":60}))]),_:1}),o(Ie,{label:"告警规则",name:"rules"},{default:u(()=>[m("div",U,[t[26]||(t[26]=m("span",{class:"tab-desc"},"配置安全事件触发条件和通知规则",-1)),o(d,{type:"primary",size:"small",onClick:_e},{default:u(()=>[...t[25]||(t[25]=[v("添加规则",-1)])]),_:1})]),y((p(),f(le,{data:ce.value,stripe:"",size:"small"},{default:u(()=>[o(c,{prop:"name",label:"规则名称","min-width":"140"}),o(c,{label:"告警类型",width:"110",align:"center"},{default:u(({row:e})=>[o(be,{type:"admin"===e.alertType?"danger":"primary",size:"small"},{default:u(()=>[v(h("admin"===e.alertType?"管理员告警":"员工告警"),1)]),_:2},1032,["type"])]),_:1}),o(c,{prop:"severityThreshold",label:"级别阈值",width:"100",align:"center"},{default:u(({row:e})=>{return[o(be,{type:(l=e.severityThreshold,(null==(a=ve[l])?void 0:a.type)||"info"),size:"small"},{default:u(()=>[v(" >= "+h(fe(e.severityThreshold)),1)]),_:2},1032,["type"])];var l,a}),_:1}),o(c,{prop:"eventTypes",label:"事件类型","min-width":"160"},{default:u(({row:e})=>[e.eventTypes&&0!==e.eventTypes.length?(p(!0),i(_,{key:1},g(e.eventTypes,e=>(p(),f(be,{key:e,size:"small",style:{"margin-right":"4px"}},{default:u(()=>{return[v(h((l=e,ye[l]||l)),1)];var l}),_:2},1024))),128)):(p(),i("span",x,"全部类型"))]),_:1}),o(c,{label:"通知方式",width:"110"},{default:u(({row:e})=>["admin"===e.alertType?(p(),i("span",C,"渠道直发")):(p(),i("span",N,"通知本人"))]),_:1}),o(c,{prop:"cooldownMinutes",label:"冷却时间",width:"90",align:"center"},{default:u(({row:e})=>[v(h(e.cooldownMinutes)+"分",1)]),_:1}),o(c,{prop:"isActive",label:"状态",width:"70",align:"center"},{default:u(({row:e})=>[o(be,{type:e.isActive?"success":"info",size:"small"},{default:u(()=>[v(h(e.isActive?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),o(c,{label:"操作",width:"120",fixed:"right"},{default:u(({row:l})=>[o(d,{type:"primary",link:"",size:"small",onClick:e=>(e=>{pe.value=e.id,Object.assign(me,{alertType:e.alertType||"admin",name:e.name,eventTypes:e.eventTypes||[],severityThreshold:e.severityThreshold,channelIds:e.channelIds||[],templateId:e.templateId||0,cooldownMinutes:e.cooldownMinutes,isActive:e.isActive}),re.value=!0})(l)},{default:u(()=>[...t[27]||(t[27]=[v("编辑",-1)])]),_:1},8,["onClick"]),o(we,{title:"确定删除此规则?",onConfirm:a=>(async l=>{try{await e.deleteAlertRule(l),s.success("删除成功"),he()}catch{s.error("删除失败")}})(l.id)},{reference:u(()=>[o(d,{type:"danger",link:"",size:"small"},{default:u(()=>[...t[28]||(t[28]=[v("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[Pe,oe.value]])]),_:1})]),_:1},8,["modelValue"]),o(Ne,{modelValue:re.value,"onUpdate:modelValue":t[11]||(t[11]=e=>re.value=e),title:pe.value?"编辑规则":"添加规则",width:"580px","destroy-on-close":""},{footer:u(()=>[o(d,{onClick:t[10]||(t[10]=e=>re.value=!1)},{default:u(()=>[...t[40]||(t[40]=[v("取消",-1)])]),_:1}),o(d,{type:"primary",onClick:ge,loading:ue.value},{default:u(()=>[...t[41]||(t[41]=[v("保存",-1)])]),_:1},8,["loading"])]),default:u(()=>[o(Ce,{model:me,"label-width":"100px"},{default:u(()=>[o(ze,{label:"告警类型",required:""},{default:u(()=>[o(Ae,{modelValue:me.alertType,"onUpdate:modelValue":t[2]||(t[2]=e=>me.alertType=e)},{default:u(()=>[o(Te,{value:"admin"},{default:u(()=>[...t[29]||(t[29]=[v(" 管理员告警 ",-1)])]),_:1}),o(Te,{value:"employee"},{default:u(()=>[...t[30]||(t[30]=[v(" 员工告警 ",-1)])]),_:1})]),_:1},8,["modelValue"]),"admin"===me.alertType?(p(),i("div",M," 通过选择的通知渠道发送告警（如 Webhook 到钉钉群、邮件到管理员邮箱等） ")):(p(),i("div",P," 通知触发安全事件的员工本人（通过渠道发送到员工绑定的邮箱/手机） "))]),_:1}),o(ze,{label:"规则名称",required:""},{default:u(()=>[o(Ue,{modelValue:me.name,"onUpdate:modelValue":t[3]||(t[3]=e=>me.name=e),placeholder:"如：高危事件告警"},null,8,["modelValue"])]),_:1}),o(ze,{label:"事件类型"},{default:u(()=>[o(W,{modelValue:me.eventTypes,"onUpdate:modelValue":t[4]||(t[4]=e=>me.eventTypes=e),multiple:"",style:{width:"100%"},placeholder:"留空表示全部类型"},{default:u(()=>[o(b,{label:"登录失败 [中]",value:"login_failed"}),o(b,{label:"登录阻止 [高]",value:"login_blocked"}),o(b,{label:"账户锁定 [高]",value:"account_locked"}),o(b,{label:"IP封禁 [高]",value:"ip_blocked"}),o(b,{label:"密码修改 [中]",value:"password_changed"}),o(b,{label:"配置变更 [中]",value:"config_changed"}),o(b,{label:"可疑活动 [高]",value:"suspicious_activity"}),o(b,{label:"会话终止 [低]",value:"session_terminated"}),o(b,{label:"登录成功 [低]",value:"login_success"})]),_:1},8,["modelValue"])]),_:1}),o(ze,{label:"级别阈值",required:""},{default:u(()=>[o(W,{modelValue:me.severityThreshold,"onUpdate:modelValue":t[5]||(t[5]=e=>me.severityThreshold=e),style:{width:"100%"}},{default:u(()=>[o(b,{label:"低及以上（全部事件）",value:"low"}),o(b,{label:"中及以上（登录失败/密码修改/配置变更等）",value:"medium"}),o(b,{label:"高及以上（登录阻止/账户锁定/IP封禁/可疑活动）",value:"high"}),o(b,{label:"仅严重（暴力破解等极端事件）",value:"critical"})]),_:1},8,["modelValue"]),m("div",G,[m("div",j,[o(be,{type:"info",size:"small"},{default:u(()=>[...t[31]||(t[31]=[v("低",-1)])]),_:1}),t[32]||(t[32]=v(" 登录成功、会话终止、IP解封",-1))]),m("div",q,[o(be,{type:"warning",size:"small"},{default:u(()=>[...t[33]||(t[33]=[v("中",-1)])]),_:1}),t[34]||(t[34]=v(" 登录失败、密码修改、配置变更、钉钉登录失败",-1))]),m("div",L,[o(be,{type:"danger",size:"small"},{default:u(()=>[...t[35]||(t[35]=[v("高",-1)])]),_:1}),t[36]||(t[36]=v(" 登录阻止、账户锁定、IP封禁、可疑活动",-1))]),m("div",R,[o(be,{type:"danger",size:"small",effect:"dark"},{default:u(()=>[...t[37]||(t[37]=[v("严重",-1)])]),_:1}),t[38]||(t[38]=v(" 暴力破解检测、异常行为检测",-1))])])]),_:1}),o(ze,{label:"通知渠道",required:""},{default:u(()=>[o(W,{modelValue:me.channelIds,"onUpdate:modelValue":t[6]||(t[6]=e=>me.channelIds=e),multiple:"",style:{width:"100%"},placeholder:"请选择通知渠道"},{default:u(()=>[(p(!0),i(_,null,g(O.value,e=>(p(),f(b,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(ze,{label:"消息模板"},{default:u(()=>[o(W,{modelValue:me.templateId,"onUpdate:modelValue":t[7]||(t[7]=e=>me.templateId=e),style:{width:"100%"},placeholder:"使用默认模板",clearable:""},{default:u(()=>[o(b,{label:"使用默认模板",value:0}),(p(!0),i(_,null,g($.value,e=>(p(),f(b,{key:e.id,label:e.name+" ("+e.scene+")",value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(ze,{label:"冷却时间"},{default:u(()=>[o(xe,{modelValue:me.cooldownMinutes,"onUpdate:modelValue":t[8]||(t[8]=e=>me.cooldownMinutes=e),min:1,max:1440},null,8,["modelValue"]),t[39]||(t[39]=m("span",{class:"form-hint"},"分钟（同类事件间隔）",-1))]),_:1}),o(ze,{label:"启用状态"},{default:u(()=>[o(J,{modelValue:me.isActive,"onUpdate:modelValue":t[9]||(t[9]=e=>me.isActive=e)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),o(Ne,{modelValue:X.value,"onUpdate:modelValue":t[17]||(t[17]=e=>X.value=e),title:Z.value?"编辑群组策略":"添加群组策略",width:"560px","destroy-on-close":""},{footer:u(()=>[o(d,{onClick:t[16]||(t[16]=e=>X.value=!1)},{default:u(()=>[...t[43]||(t[43]=[v("取消",-1)])]),_:1}),o(d,{type:"primary",onClick:ie,loading:Y.value},{default:u(()=>[...t[44]||(t[44]=[v("保存",-1)])]),_:1},8,["loading"])]),default:u(()=>[o(Ce,{model:ee,"label-width":"100px"},{default:u(()=>[o(ze,{label:"消息场景",required:""},{default:u(()=>[o(W,{modelValue:ee.scene,"onUpdate:modelValue":t[12]||(t[12]=e=>ee.scene=e),style:{width:"100%"},placeholder:"选择消息场景"},{default:u(()=>[(p(),i(_,null,g(F,e=>o(b,{key:e.scene,label:e.sceneName,value:e.scene},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(ze,{label:"适用群组",required:""},{default:u(()=>[o(Me,{modelValue:ee.targetGroupIds,"onUpdate:modelValue":t[13]||(t[13]=e=>ee.targetGroupIds=e),data:H.value,props:{children:"children",label:"name",value:"id"},multiple:"","check-strictly":"",filterable:"","default-expand-all":!1,"render-after-expand":!1,"show-checkbox":"","collapse-tags":"","collapse-tags-tooltip":"",style:{width:"100%"},placeholder:"选择适用的用户群组"},null,8,["modelValue","data"]),t[42]||(t[42]=m("div",{class:"form-hint-block"},"选择需要单独配置通知通道的群组（如外部人员），该群组下的用户将使用此策略而非默认策略",-1))]),_:1}),o(ze,{label:"通知通道",required:""},{default:u(()=>[o(W,{modelValue:ee.channelIds,"onUpdate:modelValue":t[14]||(t[14]=e=>ee.channelIds=e),multiple:"",style:{width:"100%"},placeholder:"选择通知通道"},{default:u(()=>[(p(!0),i(_,null,g(O.value,e=>(p(),f(b,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(ze,{label:"启用状态"},{default:u(()=>[o(J,{modelValue:ee.isActive,"onUpdate:modelValue":t[15]||(t[15]=e=>ee.isActive=e)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-e35f9507"]]);export{O as default};
