import{G as e,E as a}from"./elementPlus-DW6qdM9Z.js";import{k as l,_ as t}from"./index-D9Oaf6TO.js";import{v as s,k as n,D as o,E as i,F as d,r as c,ac as r,y as u,S as m,P as p,z as y,G as v,U as f,R as k,M as _,a6 as g,u as x,l as b,c as w,ad as V}from"./vendor-DDTA3iPl.js";const h={class:"template-page"},C={class:"card-header"},z={class:"scene-code"},U={key:0,class:"scene-desc"},A={class:"content-preview"},S=["textContent"],T={key:0,class:"form-tip"},j={class:"var-insert-area"},q=["onClick","textContent"],B={class:"preview-box"},E=t(s({__name:"MessageTemplates",setup(t){const s=c(!1),E=c(!1),N=c([]),P=c(!1),$=c(null),D={verify_code:"用户自助找回密码时发送的验证码",password_reset:"用户自助重置密码时发送的验证码",password_reset_notify:"管理员重置密码后，将新密码通知给用户",account_created:"钉钉同步创建新用户后，将账号和初始密码通知给用户",security_alert:"安全告警（员工侧）通知内容",admin_alert:"安全告警（管理员侧）通知内容",test:"测试消息，用于验证通知渠道是否正常"},G=[{key:"username",desc:"用户名",example:"zhangsan"},{key:"nickname",desc:"用户昵称",example:"张三"},{key:"name",desc:"姓名（真实姓名）",example:"张三"},{key:"password",desc:"密码（仅密码重置/账号开通场景）",example:"Abc@1234"},{key:"department",desc:"所属部门",example:"技术部"},{key:"code",desc:"验证码",example:"283746"},{key:"time",desc:"当前时间",example:"2026-02-08 11:30:00"},{key:"ip",desc:"来源IP地址",example:"192.168.1.100"},{key:"app_name",desc:"系统名称",example:"统一身份认证平台"}],I=e=>`{{${e}}}`,J=b({name:"",scene:"",content:"",isActive:!0,customVars:[]}),M=w(()=>{const e=J.customVars.filter(e=>e.key.trim());return[...G,...e]}),O=w(()=>{let e=J.content||"";const a=(new Date).toLocaleString("zh-CN");e=e.replace(/\{\{username\}\}/g,"testuser"),e=e.replace(/\{\{nickname\}\}/g,"测试用户"),e=e.replace(/\{\{name\}\}/g,"张三"),e=e.replace(/\{\{code\}\}/g,"283746"),e=e.replace(/\{\{time\}\}/g,a),e=e.replace(/\{\{ip\}\}/g,"192.168.1.100"),e=e.replace(/\{\{app_name\}\}/g,"统一身份认证平台");for(const l of J.customVars)if(l.key&&l.example){const a=new RegExp(`\\{\\{${l.key}\\}\\}`,"g");e=e.replace(a,l.example)}return e}),R=()=>{J.customVars.push({key:"",desc:"",example:""})},F=async()=>{s.value=!0;try{const e=await l.getTemplates();e.data.success&&(N.value=e.data.data||[])}finally{s.value=!1}},L=()=>{$.value=null,J.name="",J.scene="",J.content="",J.isActive=!0,J.customVars=[],P.value=!0},H=async()=>{var e,t;if(!J.name||!J.scene||!J.content)return void a.warning("请填写完整信息");const s=J.customVars.filter(e=>e.key.trim()),n=[...G,...s],o=JSON.stringify(n);E.value=!0;try{$.value?await l.updateTemplate($.value,{name:J.name,content:J.content,variables:o,isActive:J.isActive}):await l.createTemplate({name:J.name,scene:J.scene,content:J.content,variables:o}),a.success("保存成功"),P.value=!1,F()}catch(i){const l=(null==(t=null==(e=null==i?void 0:i.response)?void 0:e.data)?void 0:t.message)||"保存失败";a.error(l)}finally{E.value=!1}};return n(()=>{F()}),(t,n)=>{const c=r("el-button"),b=r("el-alert"),w=r("el-table-column"),K=r("el-tag"),Q=r("el-popconfirm"),W=r("el-table"),X=r("el-card"),Y=r("el-input"),Z=r("el-form-item"),ee=r("el-divider"),ae=r("el-form"),le=r("el-dialog"),te=V("loading");return u(),o("div",h,[i(X,null,{header:d(()=>[v("div",C,[n[6]||(n[6]=v("span",null,"消息模板管理",-1)),i(c,{type:"primary",size:"small",onClick:L},{default:d(()=>[...n[5]||(n[5]=[m("新增模板",-1)])]),_:1})])]),default:d(()=>[i(b,{type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:d(()=>[...n[7]||(n[7]=[m(" 消息模板用于定义各类通知消息的内容格式。内置模板不可删除但可编辑内容，自定义模板可自由管理。模板存在即生效，删除后对应场景的通知将无法发送。 ",-1)])]),_:1}),p((u(),y(W,{data:N.value,stripe:""},{default:d(()=>[i(w,{prop:"name",label:"模板名称","min-width":"140"}),i(w,{prop:"scene",label:"场景标识",width:"180"},{default:d(({row:e})=>[v("div",null,[v("code",z,f(e.scene),1),D[e.scene]?(u(),o("div",U,f(D[e.scene]),1)):k("",!0)])]),_:1}),i(w,{prop:"content",label:"模板内容","min-width":"300"},{default:d(({row:e})=>[v("span",A,f(e.content),1)]),_:1}),i(w,{label:"类型",width:"80",align:"center"},{default:d(({row:e})=>[i(K,{type:e.isBuiltin?"":"success",size:"small"},{default:d(()=>[m(f(e.isBuiltin?"内置":"自定义"),1)]),_:2},1032,["type"])]),_:1}),i(w,{label:"操作",width:"140",fixed:"right"},{default:d(({row:e})=>[i(c,{type:"primary",link:"",size:"small",onClick:a=>(e=>{if($.value=e.id,J.name=e.name,J.scene=e.scene,J.content=e.content,J.isActive=e.isActive,J.customVars=[],e.variables)try{const a="string"==typeof e.variables?JSON.parse(e.variables):e.variables,l=new Set(G.map(e=>e.key));J.customVars=a.filter(e=>!l.has(e.key))}catch{}P.value=!0})(e)},{default:d(()=>[...n[8]||(n[8]=[m("编辑",-1)])]),_:1},8,["onClick"]),e.isBuiltin?(u(),y(K,{key:1,type:"info",size:"small",style:{"margin-left":"8px",cursor:"default"}},{default:d(()=>[...n[10]||(n[10]=[m("不可删除",-1)])]),_:1})):(u(),y(Q,{key:0,title:"删除后对应场景的通知将无法发送，确定删除？",onConfirm:t=>(async e=>{var t,s;try{await l.deleteTemplate(e),a.success("删除成功"),F()}catch(n){const e=(null==(s=null==(t=null==n?void 0:n.response)?void 0:t.data)?void 0:s.message)||"删除失败";a.error(e)}})(e.id)},{reference:d(()=>[i(c,{type:"danger",link:"",size:"small"},{default:d(()=>[...n[9]||(n[9]=[m("删除",-1)])]),_:1})]),_:1},8,["onConfirm"]))]),_:1})]),_:1},8,["data"])),[[te,s.value]])]),_:1}),i(X,{style:{"margin-top":"20px"}},{header:d(()=>[...n[11]||(n[11]=[v("div",{class:"card-header"},[v("span",null,"可用变量说明")],-1)])]),default:d(()=>[i(W,{data:G,stripe:"",size:"small"},{default:d(()=>[i(w,{prop:"key",label:"变量",width:"180"},{default:d(({row:e})=>[v("code",{class:"var-code",textContent:f(I(e.key))},null,8,S)]),_:1}),i(w,{prop:"desc",label:"说明","min-width":"200"}),i(w,{prop:"example",label:"示例值",width:"220"})]),_:1})]),_:1}),i(le,{modelValue:P.value,"onUpdate:modelValue":n[4]||(n[4]=e=>P.value=e),title:$.value?"编辑消息模板":"新增消息模板",width:"620px","destroy-on-close":""},{footer:d(()=>[i(c,{onClick:n[3]||(n[3]=e=>P.value=!1)},{default:d(()=>[...n[16]||(n[16]=[m("取消",-1)])]),_:1}),i(c,{type:"primary",onClick:H,loading:E.value},{default:d(()=>[...n[17]||(n[17]=[m("保存",-1)])]),_:1},8,["loading"])]),default:d(()=>[i(ae,{model:J,"label-width":"100px"},{default:d(()=>[i(Z,{label:"模板名称",required:""},{default:d(()=>[i(Y,{modelValue:J.name,"onUpdate:modelValue":n[0]||(n[0]=e=>J.name=e),placeholder:"如：用户注册通知"},null,8,["modelValue"])]),_:1}),i(Z,{label:"场景标识",required:""},{default:d(()=>[i(Y,{modelValue:J.scene,"onUpdate:modelValue":n[1]||(n[1]=e=>J.scene=e),placeholder:"如：user_register",disabled:!!$.value},null,8,["modelValue","disabled"]),$.value?k("",!0):(u(),o("div",T,[...n[12]||(n[12]=[m(" 唯一标识，创建后不可修改。建议使用英文小写+下划线，如 ",-1),v("code",null,"order_notify",-1)])])),$.value&&D[J.scene]?(u(),y(b,{key:1,title:"用途："+D[J.scene],type:"info",closable:!1,"show-icon":"",style:{"margin-top":"6px"}},null,8,["title"])):k("",!0)]),_:1}),i(Z,{label:"模板内容",required:""},{default:d(()=>[i(Y,{modelValue:J.content,"onUpdate:modelValue":n[2]||(n[2]=e=>J.content=e),type:"textarea",rows:5,placeholder:"请输入消息模板内容，支持变量替换"},null,8,["modelValue"])]),_:1}),i(Z,{label:"插入变量"},{default:d(()=>[v("div",j,[(u(!0),o(_,null,g(M.value,e=>(u(),o("code",{key:e.key,class:"var-tag clickable",onClick:a=>{return l=e.key,void(J.content+=`{{${l}}}`);var l},textContent:f(I(e.key))},null,8,q))),128))])]),_:1}),i(Z,{label:"预览"},{default:d(()=>[v("div",B,f(O.value),1)]),_:1}),i(ee,{"content-position":"left"},{default:d(()=>[...n[13]||(n[13]=[m("自定义变量（可选）",-1)])]),_:1}),i(b,{type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:d(()=>[...n[14]||(n[14]=[m(" 除内置变量外，您可以为此模板定义额外的自定义变量。 ",-1)])]),_:1}),(u(!0),o(_,null,g(J.customVars,(a,l)=>(u(),o("div",{key:l,class:"custom-var-row"},[i(Y,{modelValue:a.key,"onUpdate:modelValue":e=>a.key=e,placeholder:"变量名",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),i(Y,{modelValue:a.desc,"onUpdate:modelValue":e=>a.desc=e,placeholder:"说明",style:{width:"160px",margin:"0 8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(Y,{modelValue:a.example,"onUpdate:modelValue":e=>a.example=e,placeholder:"示例值",style:{width:"140px","margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(c,{type:"danger",circle:"",size:"small",icon:x(e),onClick:e=>(e=>{J.customVars.splice(e,1)})(l)},null,8,["icon","onClick"])]))),128)),i(c,{type:"primary",link:"",size:"small",onClick:R,style:{"margin-top":"8px"}},{default:d(()=>[...n[15]||(n[15]=[m(" + 添加自定义变量 ",-1)])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-0e154ba1"]]);export{E as default};
