import{v as a,k as e,D as l,aA as t,G as o,M as s,a6 as r,U as n,E as c,F as i,$ as d,R as u,aB as v,l as f,r as p,ac as g,y as m,H as h,u as w,am as b,S as y,I as k,c as x}from"./vendor-DDTA3iPl.js";import{E as V,a as P,u as I,l as C}from"./elementPlus-DW6qdM9Z.js";import{u as L,s as S,a as M,b as _,_ as U}from"./index-D9Oaf6TO.js";const T={class:"login-container"},z={class:"bg-layer"},B={class:"iot-graphic"},E={class:"data-particles"},G={class:"login-card"},j={class:"card-content"},Z={class:"card-header"},$={class:"remember-row"},A={key:0},K={key:1},D={class:"forgot-content"},N={key:0,class:"forgot-step"},Q={class:"forgot-field"},H={key:1,class:"forgot-step"},O={class:"forgot-user-info"},F={key:0,class:"forgot-field"},R={class:"method-options"},q=["onClick"],J={class:"forgot-field"},W={class:"code-row"},X={key:0,class:"forgot-hint"},Y={class:"forgot-field"},aa={class:"forgot-field"},ea={key:2,class:"forgot-step forgot-success"},la={key:0,class:"page-footer"},ta={key:0},oa={key:1,class:"footer-divider"},sa={key:2,class:"footer-divider footer-icp-link",href:"https://beian.miit.gov.cn/",target:"_blank",rel:"noopener noreferrer"},ra=U(a({__name:"Login",setup(a){const U=v(),ra=L(),na=f({username:"",password:""}),ca=p(!1),ia=p(!1),da=p(!1),ua=p({browserTitle:"",loginTitle:"",footerShortName:"",footerCompany:"",footerICP:""}),va=a=>{const e=30*a*Math.PI/180,l=120+a%3*40;return{"--x":`${Math.cos(e)*l}px`,"--y":`${Math.sin(e)*l}px`,"--delay":`${.3*a}s`,"--duration":`${3+a%3}s`}},fa=async()=>{var a,e,l;if(na.username&&na.password){ca.value=!0;try{const e=await ra.login(na.username,na.password);if(e.success){ia.value?localStorage.setItem("rememberedUser",na.username):localStorage.removeItem("rememberedUser"),V.success("登录成功");const e=null==(a=ra.layoutConfig)?void 0:a.landingPage;U.push(e||"/admin")}else V.error(e.message||"登录失败")}catch(t){V.error((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.message)||"登录失败")}finally{ca.value=!1}}else V.warning("请输入用户名和密码")},pa=p(!1),ga=p(1),ma=p(!1),ha=p(!1),wa=p(0);let ba=null;const ya=p(""),ka=p([]),xa=f({username:"",method:"",code:"",newPassword:"",confirmPassword:""}),Va=x(()=>{const a=ka.value.find(a=>a.key===xa.method);return(null==a?void 0:a.hint)||""}),Pa=()=>{ga.value=1,xa.username=na.username||"",xa.method="",xa.code="",xa.newPassword="",xa.confirmPassword="",wa.value=0,pa.value=!0},Ia=async()=>{var a,e;if(!xa.username)return V.warning("请输入用户名");ma.value=!0;try{const a=await M.forgotPassword.check(xa.username);if(a.data.success){const e=a.data.data.methods||[];if(0===e.length)return void V.warning("该用户无可用的验证方式，请联系管理员重置密码");ya.value=a.data.data.nickname||xa.username,a.data.data.username&&(xa.username=a.data.data.username),ka.value=e,xa.method=e[0].key,ga.value=2}}catch(l){V.error((null==(e=null==(a=l.response)?void 0:a.data)?void 0:e.message)||"查询失败")}finally{ma.value=!1}},Ca=async()=>{var a,e,l;if(!xa.method)return V.warning("请选择验证方式");ha.value=!0;try{const e=await M.forgotPassword.sendCode(xa.username,xa.method);e.data.success&&(V.success((null==(a=e.data.data)?void 0:a.message)||"验证码已发送"),wa.value=60,ba&&clearInterval(ba),ba=setInterval(()=>{--wa.value<=0&&ba&&(clearInterval(ba),ba=null)},1e3))}catch(t){V.error((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.message)||"发送失败")}finally{ha.value=!1}},La=async()=>{var a,e;if(!xa.code)return V.warning("请输入验证码");if(!xa.newPassword)return V.warning("请输入新密码");const l=(t=xa.newPassword).length<8?"密码长度至少8位":t.length>128?"密码长度不能超过128位":/[A-Z]/.test(t)?/[a-z]/.test(t)?/[0-9]/.test(t)?null:"密码必须包含数字":"密码必须包含小写字母":"密码必须包含大写字母";var t;if(l)return V.warning(l);if(xa.newPassword!==xa.confirmPassword)return V.warning("两次输入的密码不一致");ma.value=!0;try{(await M.forgotPassword.reset({username:xa.username,method:xa.method,code:xa.code,newPassword:xa.newPassword})).data.success&&(ga.value=3)}catch(o){V.error((null==(e=null==(a=o.response)?void 0:a.data)?void 0:e.message)||"重置失败")}finally{ma.value=!1}},Sa=()=>{na.username=xa.username,na.password="",pa.value=!1},Ma=p([]),_a=p(!1),Ua=async()=>{const a=new URLSearchParams(window.location.search),e=a.get("sso"),l=a.get("code"),t=a.get("cid");if(!e||!l||!t)return!1;_a.value=!0;try{const a="feishu"===e?"im_feishu":"im_wechatwork";return await(async(a,e)=>{var l,t,o;const s=await _.ssoLogin({connectorId:a.connectorId,platform:a.platform,authCode:e});if(!(null==(l=s.data)?void 0:l.success))throw new Error((null==(o=s.data)?void 0:o.message)||"SSO登录失败");{const{token:a,user:e}=s.data.data;localStorage.setItem("token",a),ra.setToken(a),ra.setUser(e),await ra.fetchUserInfo(),V.success("登录成功");const l=null==(t=ra.layoutConfig)?void 0:t.landingPage;U.push(l||"/")}})({connectorId:parseInt(t),platform:a},l),!0}catch(o){return V.error((null==o?void 0:o.message)||"SSO登录失败"),window.history.replaceState({},"","/login"),!1}finally{_a.value=!1}},Ta=()=>new Promise((a,e)=>{if(window.dd)return void a();const l=setTimeout(()=>{e(new Error("加载钉钉SDK超时"))},5e3),t=document.createElement("script");t.src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.12/dingtalk.open.js",t.onload=()=>{clearTimeout(l),a()},t.onerror=()=>{clearTimeout(l),e(new Error("加载钉钉SDK失败"))},document.head.appendChild(t)});return e(async()=>{const a=localStorage.getItem("rememberedUser");a&&(na.username=a,ia.value=!0);try{const a=await S.getUI();a.data.success&&(ua.value=a.data.data,ua.value.browserTitle&&(document.title=ua.value.browserTitle))}catch(e){}(async()=>{var a;try{const e=await _.ssoProviders();Ma.value=(null==(a=e.data)?void 0:a.data)||[]}catch{Ma.value=[]}})();if(!(await Ua())&&navigator.userAgent.toLowerCase().indexOf("dingtalk")>-1){if(localStorage.getItem("token"))try{const a=await M.getInfo();if(a.data.success&&a.data.data)return ra.setUser(a.data.data),void U.push("/")}catch(l){localStorage.removeItem("token"),ra.clearAuth()}try{const a=(async()=>{var a;let t=null;try{let o="",s=null;try{const e=(null==(a=(await _.ssoProviders()).data)?void 0:a.data)||[];s=e.find(a=>"im_dingtalk"===a.platform),(null==s?void 0:s.corpId)&&(o=s.corpId)}catch(l){}if(!o)try{const a=await S.getDingtalkStatus();a.data.success&&a.data.data.enabled&&a.data.data.corpId&&(o=a.data.data.corpId)}catch(l){}if(!o)return;if(da.value=!0,t=P.service({text:"钉钉免登中...",background:"rgba(255, 255, 255, 0.8)"}),void 0===window.dd)try{await Ta()}catch(l){return null==t||t.close(),void(da.value=!1)}const r=window.dd;if(!r)return null==t||t.close(),void(da.value=!1);await new Promise((a,l)=>{var t;const n=setTimeout(()=>{l(new Error("获取授权码超时"))},5e3);r.ready(()=>{r.runtime.permission.requestAuthCode({corpId:o,onSuccess:async t=>{var o,r,c;clearTimeout(n);try{let e;if(e=s?await _.ssoLogin({connectorId:s.connectorId,platform:"im_dingtalk",authCode:t.code}):await M.dingtalkLogin(t.code),e.data.success){const{token:l,user:t}=e.data.data;localStorage.setItem("token",l),ra.setToken(l),ra.setUser(t),await ra.fetchUserInfo(),V.success("钉钉免登成功");const s=null==(o=ra.layoutConfig)?void 0:o.landingPage;U.push(s||"/"),a()}else V.error(e.data.message||"钉钉免登失败"),l(new Error(e.data.message))}catch(e){V.error((null==(c=null==(r=e.response)?void 0:r.data)?void 0:c.message)||"钉钉免登失败"),l(e)}},onFail:a=>{clearTimeout(n),l(a)}})}),null==(t=r.error)||t.call(r,a=>{clearTimeout(n),l(a)})})}catch(l){}finally{null==t||t.close(),da.value=!1}})(),t=new Promise((a,e)=>setTimeout(()=>e(new Error("钉钉登录超时")),1e4));await Promise.race([a,t])}catch(l){da.value=!1}}}),(a,e)=>{const v=g("el-input"),f=g("el-form-item"),p=g("el-checkbox"),x=g("el-button"),V=g("el-form"),P=g("el-dialog");return m(),l("div",T,[e[29]||(e[29]=t('<div class="top-bar" data-v-28f4bc30><div class="brand" data-v-28f4bc30><svg class="brand-logo" viewBox="0 0 32 32" fill="none" data-v-28f4bc30><circle cx="16" cy="16" r="14" fill="#3b82f6" data-v-28f4bc30></circle><path d="M16 6L26 12V20L16 26L6 20V12L16 6Z" fill="white" fill-opacity="0.9" data-v-28f4bc30></path><path d="M16 10L22 14V18L16 22L10 18V14L16 10Z" fill="#3b82f6" data-v-28f4bc30></path></svg><span class="brand-title" data-v-28f4bc30>统一用户管理平台</span></div><div class="top-bar-right" data-v-28f4bc30></div></div>',1)),o("div",z,[o("div",B,[e[9]||(e[9]=t('<div class="center-ring" data-v-28f4bc30><div class="ring ring-1" data-v-28f4bc30></div><div class="ring ring-2" data-v-28f4bc30></div><div class="ring ring-3" data-v-28f4bc30></div><div class="center-icon" data-v-28f4bc30><svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-28f4bc30><circle cx="32" cy="32" r="8" fill="#3b82f6" data-v-28f4bc30></circle><path d="M32 12V20M32 44V52M12 32H20M44 32H52" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" data-v-28f4bc30></path><circle cx="32" cy="12" r="4" fill="#60a5fa" data-v-28f4bc30></circle><circle cx="32" cy="52" r="4" fill="#60a5fa" data-v-28f4bc30></circle><circle cx="12" cy="32" r="4" fill="#60a5fa" data-v-28f4bc30></circle><circle cx="52" cy="32" r="4" fill="#60a5fa" data-v-28f4bc30></circle></svg></div></div><div class="floating-device device-1" data-v-28f4bc30><svg viewBox="0 0 40 40" fill="none" data-v-28f4bc30><circle cx="20" cy="16" r="8" stroke="#3b82f6" stroke-width="2" data-v-28f4bc30></circle><path d="M12 30C12 25.5817 15.5817 22 20 22C24.4183 22 28 25.5817 28 30" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" data-v-28f4bc30></path></svg><span data-v-28f4bc30>用户</span></div><div class="floating-device device-2" data-v-28f4bc30><svg viewBox="0 0 40 40" fill="none" data-v-28f4bc30><rect x="8" y="6" width="24" height="28" rx="3" stroke="#0ea5e9" stroke-width="2" data-v-28f4bc30></rect><circle cx="20" cy="14" r="5" stroke="#0ea5e9" stroke-width="2" data-v-28f4bc30></circle><path d="M12 28C12 24.6863 15.5817 22 20 22C24.4183 22 28 24.6863 28 28" stroke="#0ea5e9" stroke-width="2" data-v-28f4bc30></path></svg><span data-v-28f4bc30>组织</span></div><div class="floating-device device-3" data-v-28f4bc30><svg viewBox="0 0 40 40" fill="none" data-v-28f4bc30><path d="M20 6L32 14V26L20 34L8 26V14L20 6Z" stroke="#6366f1" stroke-width="2" data-v-28f4bc30></path><circle cx="20" cy="20" r="5" fill="#6366f1" fill-opacity="0.2" stroke="#6366f1" stroke-width="2" data-v-28f4bc30></circle></svg><span data-v-28f4bc30>角色</span></div><div class="floating-device device-4" data-v-28f4bc30><svg viewBox="0 0 40 40" fill="none" data-v-28f4bc30><rect x="6" y="10" width="28" height="20" rx="3" stroke="#8b5cf6" stroke-width="2" data-v-28f4bc30></rect><circle cx="20" cy="20" r="6" stroke="#8b5cf6" stroke-width="2" data-v-28f4bc30></circle><path d="M14 20L18 24L26 16" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-28f4bc30></path></svg><span data-v-28f4bc30>安全</span></div><svg class="connection-lines" viewBox="0 0 400 400" data-v-28f4bc30><defs data-v-28f4bc30><linearGradient id="lineGrad" x1="0%" y1="0%" x2="100%" y2="0%" data-v-28f4bc30><stop offset="0%" stop-color="#3b82f6" stop-opacity="0" data-v-28f4bc30></stop><stop offset="50%" stop-color="#3b82f6" stop-opacity="0.6" data-v-28f4bc30></stop><stop offset="100%" stop-color="#3b82f6" stop-opacity="0" data-v-28f4bc30></stop></linearGradient></defs><path class="conn-line line-1" d="M80,100 Q150,150 200,200" stroke="url(#lineGrad)" stroke-width="2" fill="none" data-v-28f4bc30></path><path class="conn-line line-2" d="M320,100 Q250,150 200,200" stroke="url(#lineGrad)" stroke-width="2" fill="none" data-v-28f4bc30></path><path class="conn-line line-3" d="M80,300 Q150,250 200,200" stroke="url(#lineGrad)" stroke-width="2" fill="none" data-v-28f4bc30></path><path class="conn-line line-4" d="M320,300 Q250,250 200,200" stroke="url(#lineGrad)" stroke-width="2" fill="none" data-v-28f4bc30></path></svg>',6)),o("div",E,[(m(),l(s,null,r(12,a=>o("div",{class:"particle",key:"p"+a,style:h(va(a))},null,4)),64))])]),e[10]||(e[10]=o("div",{class:"circle circle-1"},null,-1)),e[11]||(e[11]=o("div",{class:"circle circle-2"},null,-1)),e[12]||(e[12]=o("div",{class:"circle circle-3"},null,-1))]),o("div",G,[o("div",j,[o("div",Z,[e[13]||(e[13]=t('<div class="logo-icon" data-v-28f4bc30><svg viewBox="0 0 48 48" fill="none" data-v-28f4bc30><circle cx="24" cy="24" r="20" fill="#3b82f6" fill-opacity="0.1" data-v-28f4bc30></circle><path d="M24 8L36 16V32L24 40L12 32V16L24 8Z" fill="#3b82f6" data-v-28f4bc30></path><path d="M24 16L30 20V28L24 32L18 28V20L24 16Z" fill="white" data-v-28f4bc30></path></svg></div>',1)),o("h2",null,n(ua.value.loginTitle||"账号登录"),1),e[14]||(e[14]=o("p",{class:"subtitle"},"欢迎使用统一用户管理平台",-1))]),c(V,{model:na,onSubmit:d(fa,["prevent"]),class:"login-form"},{default:i(()=>[c(f,null,{default:i(()=>[c(v,{modelValue:na.username,"onUpdate:modelValue":e[0]||(e[0]=a=>na.username=a),placeholder:"请输入用户名",size:"large","prefix-icon":w(I)},null,8,["modelValue","prefix-icon"])]),_:1}),c(f,null,{default:i(()=>[c(v,{modelValue:na.password,"onUpdate:modelValue":e[1]||(e[1]=a=>na.password=a),type:"password",placeholder:"请输入密码",size:"large","prefix-icon":w(C),"show-password":"",onKeyup:b(fa,["enter"])},null,8,["modelValue","prefix-icon"])]),_:1}),c(f,null,{default:i(()=>[o("div",$,[c(p,{modelValue:ia.value,"onUpdate:modelValue":e[2]||(e[2]=a=>ia.value=a)},{default:i(()=>[...e[15]||(e[15]=[y("记住账号",-1)])]),_:1},8,["modelValue"]),o("a",{class:"forgot-link",onClick:Pa},"忘记密码？")])]),_:1}),c(f,null,{default:i(()=>[c(x,{type:"primary",size:"large",class:"login-btn",loading:ca.value,onClick:fa},{default:i(()=>[ca.value?(m(),l("span",K,"登录中...")):(m(),l("span",A,"登 录"))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),e[16]||(e[16]=o("div",{class:"card-footer"},[o("p",null,"统一身份 · 高效管理")],-1))])]),c(P,{modelValue:pa.value,"onUpdate:modelValue":e[8]||(e[8]=a=>pa.value=a),title:"",width:"420px","close-on-click-modal":!1,class:"forgot-dialog","destroy-on-close":""},{default:i(()=>[o("div",D,[e[28]||(e[28]=o("div",{class:"forgot-header"},[o("svg",{viewBox:"0 0 48 48",fill:"none",width:"40",height:"40"},[o("circle",{cx:"24",cy:"24",r:"20",fill:"#eff6ff"}),o("path",{d:"M24 14a6 6 0 0 0-6 6v2h-1a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1v-2a6 6 0 0 0-6-6zm-3 8v-2a3 3 0 1 1 6 0v2h-6z",fill:"#3b82f6"})]),o("h3",null,"忘记密码"),o("p",null,"通过验证码重置您的登录密码")],-1)),1===ga.value?(m(),l("div",N,[o("div",Q,[e[17]||(e[17]=o("label",null,"用户名",-1)),c(v,{modelValue:xa.username,"onUpdate:modelValue":e[3]||(e[3]=a=>xa.username=a),placeholder:"用户名 / 手机号 / 邮箱",size:"large",onKeyup:b(Ia,["enter"])},null,8,["modelValue"])]),c(x,{type:"primary",size:"large",class:"forgot-btn",onClick:Ia,loading:ma.value},{default:i(()=>[...e[18]||(e[18]=[y("下一步",-1)])]),_:1},8,["loading"])])):u("",!0),2===ga.value?(m(),l("div",H,[o("div",O,[o("span",null,n(ya.value),1),o("a",{onClick:e[4]||(e[4]=a=>ga.value=1),class:"change-user"},"换一个账号")]),ka.value.length>1?(m(),l("div",F,[e[19]||(e[19]=o("label",null,"验证方式",-1)),o("div",R,[(m(!0),l(s,null,r(ka.value,a=>(m(),l("button",{key:a.key,class:k(["method-btn",{active:xa.method===a.key}]),onClick:e=>xa.method=a.key},n(a.name),11,q))),128))])])):u("",!0),o("div",J,[e[20]||(e[20]=o("label",null,"验证码",-1)),o("div",W,[c(v,{modelValue:xa.code,"onUpdate:modelValue":e[5]||(e[5]=a=>xa.code=a),placeholder:"请输入6位验证码",size:"large"},null,8,["modelValue"]),c(x,{size:"large",onClick:Ca,disabled:wa.value>0,loading:ha.value},{default:i(()=>[y(n(wa.value>0?`${wa.value}s`:"获取验证码"),1)]),_:1},8,["disabled","loading"])]),Va.value?(m(),l("span",X,n(Va.value),1)):u("",!0)]),o("div",Y,[e[21]||(e[21]=o("label",null,"新密码",-1)),c(v,{modelValue:xa.newPassword,"onUpdate:modelValue":e[6]||(e[6]=a=>xa.newPassword=a),type:"password","show-password":"",placeholder:"至少8位，需包含大小写字母和数字",size:"large"},null,8,["modelValue"])]),o("div",aa,[e[22]||(e[22]=o("label",null,"确认新密码",-1)),c(v,{modelValue:xa.confirmPassword,"onUpdate:modelValue":e[7]||(e[7]=a=>xa.confirmPassword=a),type:"password","show-password":"",placeholder:"再次输入新密码",size:"large",onKeyup:b(La,["enter"])},null,8,["modelValue"])]),c(x,{type:"primary",size:"large",class:"forgot-btn",onClick:La,loading:ma.value},{default:i(()=>[...e[23]||(e[23]=[y("重置密码",-1)])]),_:1},8,["loading"])])):u("",!0),3===ga.value?(m(),l("div",ea,[e[25]||(e[25]=o("svg",{viewBox:"0 0 64 64",fill:"none",width:"56",height:"56"},[o("circle",{cx:"32",cy:"32",r:"28",fill:"#f0fdf4"}),o("path",{d:"M20 32l8 8 16-16",stroke:"#22c55e","stroke-width":"4","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),e[26]||(e[26]=o("h4",null,"密码重置成功",-1)),e[27]||(e[27]=o("p",null,"请使用新密码登录",-1)),c(x,{type:"primary",size:"large",class:"forgot-btn",onClick:Sa},{default:i(()=>[...e[24]||(e[24]=[y("返回登录",-1)])]),_:1})])):u("",!0)])]),_:1},8,["modelValue"]),ua.value.footerShortName||ua.value.footerCompany||ua.value.footerICP?(m(),l("div",la,[ua.value.footerShortName?(m(),l("span",ta,"Powered By "+n(ua.value.footerShortName),1)):u("",!0),ua.value.footerCompany?(m(),l("span",oa,n(ua.value.footerCompany),1)):u("",!0),ua.value.footerICP?(m(),l("a",sa,n(ua.value.footerICP),1)):u("",!0)])):u("",!0)])}}}),[["__scopeId","data-v-28f4bc30"]]);export{ra as default};
