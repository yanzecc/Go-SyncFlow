import{v as e,k as a,D as l,G as t,E as n,F as s,c as d,r as u,ac as o,l as i,y as r,I as c,U as p,z as m,S as v,R as f,M as h,$ as y,u as g,P as _,am as w,a6 as k,ad as b}from"./vendor-DDTA3iPl.js";import{D as I,F as x,G as V,H as C,I as z,J as U,r as R,E as P,K as S}from"./elementPlus-DW6qdM9Z.js";import{u as T,d as $,g as F,e as E,r as j,s as B,f as D,b as N,_ as O}from"./index-D9Oaf6TO.js";const A={class:"users-page"},L={class:"main-content"},q={class:"group-node"},G={class:"group-node-actions"},K={class:"card-header-row"},M={class:"filter-item"},H={key:0,class:"action-btns"},J={key:1,class:"action-btns"},Q={key:0,class:"batch-bar"},W={class:"batch-count-text"},X={class:"pagination-row"},Y={class:"total-text"},Z={style:{"font-weight":"500"}},ee={key:0,style:{display:"flex",gap:"8px","flex-wrap":"wrap"}},ae={key:1,style:{color:"var(--color-text-tertiary)","font-size":"13px"}},le={style:{"margin-bottom":"16px"}},te={key:0,style:{display:"flex",gap:"8px","flex-wrap":"wrap"}},ne={key:1,style:{color:"var(--color-text-tertiary)","font-size":"13px"}},se={class:"form-tip"},de=O(e({__name:"Users",setup(e){const O=T(),de=d(()=>O.hasPermission("user:create")),ue=d(()=>O.hasPermission("user:update")),oe=d(()=>O.hasPermission("user:delete")),ie=d(()=>O.hasPermission("user:reset_password")||O.hasPermission("user:update")),re=d(()=>O.hasPermission("user:toggle_status")||O.hasPermission("user:update")),ce=d(()=>O.hasPermission("user:create_group")||O.hasPermission("user:create")),pe=d(()=>O.hasPermission("user:assign_role")),me=d(()=>O.hasPermission("user:export")||O.hasPermission("settings:system")),ve=d(()=>O.hasPermission("dingtalk:list")),fe=d(()=>O.hasPermission("dingtalk:sync")),he=u(!1),ye=async()=>{he.value=!0;try{const e=await fetch("/api/users/export",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok)throw new Error("导出失败");const a=await e.blob(),l=URL.createObjectURL(a),t=document.createElement("a");t.href=l,t.download=`users_${(new Date).toISOString().slice(0,10)}.xlsx`,t.click(),URL.revokeObjectURL(l),P.success("导出成功")}catch(e){P.error((null==e?void 0:e.message)||"导出失败")}finally{he.value=!1}},ge=u(!1),_e=u("local"),we=u(0),ke=u(0),be=e=>{_e.value!==e&&(_e.value=e,qe.value="","local"===e?(Se.value=null,Qe.page=1,ba()):(Ee.value=null,Ne.page=1,ja()))},Ie=()=>{"local"===_e.value?(Qe.page=1,ba()):(Ne.page=1,ja())},xe=u(),Ve=u(["root-local"]),Ce=d(()=>{const e=[{_uid:"root-local",_isRoot:!0,_source:"local",label:"本地用户",children:ze(Pe.value)}];if(ge.value&&ve.value){const a={_uid:"root-dingtalk",_isRoot:!0,_source:"dingtalk",label:"钉钉",children:Ue(Fe.value)};e.push(a)}return e}),ze=e=>{const a={},l=[];return e.forEach(e=>{a[e.id]={_uid:`local-${e.id}`,_source:"local",_groupId:e.id,label:e.name,id:e.id,parentId:e.parentId,children:[]}}),e.forEach(e=>{const t=a[e.id];e.parentId&&0!==e.parentId&&a[e.parentId]?a[e.parentId].children.push(t):l.push(t)}),1===l.length&&l[0].children.length>0?l[0].children:l},Ue=e=>{const a={},l=[];return e.forEach(e=>{a[e.deptId]={_uid:`dt-${e.deptId}`,_source:"dingtalk",_deptId:e.deptId,label:e.name,deptId:e.deptId,parentId:e.parentId,children:[]}}),e.forEach(e=>{const t=a[e.deptId];e.parentId&&0!==e.parentId&&a[e.parentId]?a[e.parentId].children.push(t):l.push(t)}),1===l.length&&l[0].children.length>0?l[0].children:l},Re=e=>{e._isRoot&&"local"===e._source?(be("local"),Se.value=null,Qe.page=1,ba()):e._isRoot&&"dingtalk"===e._source?(be("dingtalk"),Ee.value=null,Ne.page=1,ja()):"local"===e._source?(_e.value="local",wa(e._groupId,e.label)):"dingtalk"===e._source&&(_e.value="dingtalk",Ee.value=e._deptId,Ne.page=1,ja())},Pe=u([]),Se=u(null),Te=u("全部用户"),$e=u(0),Fe=u([]),Ee=u(null),je=u([]),Be=u(!1),De=u(!1),Ne=i({page:1,size:20,total:0}),Oe=u(!1),Ae=u(!1),Le=i({usernameField:"email_prefix",syncInterval:0,defaultRoleId:2,autoRegister:!0}),qe=u(""),Ge=u(!1),Ke=u(!1),Me=u(!1),He=u([]),Je=u([]),Qe=i({page:1,size:20,total:0}),We=u(!1),Xe=u(!1),Ye=u(0),Ze=u(""),ea=d(()=>Xe.value&&("dingtalk"===Ze.value||"im_dingtalk"===Ze.value||"im_wechatwork"===Ze.value||"im_feishu"===Ze.value||"im_welink"===Ze.value)),aa=i({username:"",password:"",nickname:"",phone:"",email:"",status:1,roleIds:[],groupId:null}),la=u(!1),ta=i({userId:0,username:"",nickname:"",phone:"",dingtalkUid:"",notifyChannels:[]}),na=u([]),sa=async e=>{var a,l,t,n;try{const s={scene:"password_reset_notify"};e&&e>0&&(s.groupId=e);let d=await D.get("/notify/policies/scene",{params:s}),u=null==(a=d.data)?void 0:a.data;if(!((null==u?void 0:u.isActive)&&(null==(l=u.channelNames)?void 0:l.length)>0)){const a={scene:"password_reset"};e&&e>0&&(a.groupId=e),d=await D.get("/notify/policies/scene",{params:a}),u=null==(t=d.data)?void 0:t.data}(null==u?void 0:u.isActive)&&(null==(n=u.channelNames)?void 0:n.length)>0?(na.value=u.channelNames,ta.notifyChannels=u.channelTypes||[]):(na.value=[],ta.notifyChannels=[])}catch{na.value=[],ta.notifyChannels=[]}},da=u([]),ua=u(),oa=u(!1),ia=u([]),ra=u([]),ca=u(!1),pa=u(!1),ma=i({total:0,success:0,results:[]}),va=u(!1),fa=u(!1),ha=u(0),ya=u(!1),ga=i({name:"",parentId:null}),_a=d(()=>{const e={},a=[];return Pe.value.forEach(a=>{e[a.id]={...a,children:[]}}),Pe.value.forEach(l=>{const t=e[l.id];l.parentId&&0!==l.parentId&&e[l.parentId]?e[l.parentId].children.push(t):a.push(t)}),1===a.length&&a[0].children.length>0?a[0].children:a}),wa=(e,a)=>{Se.value=e,Te.value=a,Qe.page=1,ba()},ka=async()=>{try{const e=await F.list();e.data.success&&(Pe.value=e.data.data.groups||[],$e.value=e.data.data.ungroupedCount||0)}catch(e){}},ba=async()=>{Ge.value=!0;try{const e={pageIndex:Qe.page-1,pageSize:Qe.size,keyword:qe.value};null!==Se.value&&(e.groupId=Se.value);const a=await E.list(e);a.data.success&&(He.value=a.data.data.list||[],Qe.total=a.data.data.total||0,null===Se.value&&(we.value=Qe.total))}catch(e){}finally{Ge.value=!1}},Ia=async()=>{try{const e=await j.list();e.data.success&&(Je.value=e.data.data||[])}catch(e){}},xa=()=>{fa.value=!1,ha.value=0,ga.name="",ga.parentId=null,va.value=!0},Va=async()=>{if(ga.name.trim()){ya.value=!0;try{if(fa.value){(await F.update(ha.value,{name:ga.name,parentId:ga.parentId||0})).data.success&&(P.success("保存成功"),va.value=!1,ka())}else{(await F.create({name:ga.name,parentId:ga.parentId||0})).data.success&&(P.success("创建成功"),va.value=!1,ka())}}catch(e){}finally{ya.value=!1}}else P.warning("请输入分组名称")},Ca=()=>{Xe.value=!1,Ye.value=0,Ze.value="local",Object.assign(aa,{username:"",password:"",nickname:"",phone:"",email:"",status:1,roleIds:[],groupId:null!==Se.value&&Se.value>0?Se.value:null}),Ia(),We.value=!0},za=async()=>{Ke.value=!0;try{const e={...aa,groupId:aa.groupId||0};if(Xe.value)await E.update(Ye.value,e),P.success("保存成功");else{if(!aa.username||!aa.password)return P.warning("请填写用户名和密码"),void(Ke.value=!1);await E.create(e),P.success("创建成功")}We.value=!1,ba(),ka()}catch(e){}finally{Ke.value=!1}},Ua=async()=>{if(0===ta.notifyChannels.length)try{await S.confirm("未选择任何通知方式，员工将无法收到新密码。是否继续？","提示",{type:"warning",confirmButtonText:"继续重置",cancelButtonText:"返回"})}catch{return}Me.value=!0;try{const e=(await E.resetPassword(ta.userId,ta.notifyChannels)).data,a=(null==e?void 0:e.notifyResult)||"";P.success(`密码重置成功。${a}`),la.value=!1,ba()}catch(e){}finally{Me.value=!1}},Ra=e=>{da.value=e},Pa=()=>{var e;null==(e=ua.value)||e.clearSelection(),da.value=[]},Sa=()=>{ia.value=[...da.value],ra.value=[],sa(),oa.value=!0},Ta=async()=>{if(0===ra.value.length)try{await S.confirm("未选择任何通知方式，员工将无法收到新密码。是否继续？","提示",{type:"warning",confirmButtonText:"继续重置",cancelButtonText:"返回"})}catch{return}ca.value=!0;try{const e=ia.value.map(e=>e.id),a=(await E.batchResetPassword(e,ra.value)).data;ma.total=a.total||0,ma.success=a.success||0,ma.results=a.results||[],oa.value=!1,pa.value=!0,Pa(),ba()}catch(e){}finally{ca.value=!1}},$a=e=>{S.confirm(`确定删除用户「${e.nickname||e.username}」(${e.username}) 吗？删除后该用户将无法登录。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(()=>(async e=>{try{await E.delete(e.id),P.success("删除成功"),ba(),ka()}catch(a){}})(e)).catch(()=>{})},Fa=()=>{const e=da.value.filter(e=>"admin"!==e.username);0!==e.length?S.confirm(`确定删除选中的 ${e.length} 名用户吗？删除后这些用户将无法登录。`,"批量删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{let a=0;for(const t of e)try{await E.delete(t.id),a++}catch(l){}P.success(`成功删除 ${a} 名用户`),Pa(),ba(),ka()}).catch(()=>{}):P.warning("没有可删除的用户（admin 不可删除）")},Ea=async()=>{try{const e=await $.departments();e.data.success&&(Fe.value=e.data.data||[])}catch(e){}},ja=async()=>{Be.value=!0;try{const e={page:Ne.page,pageSize:Ne.size,keyword:qe.value};null!==Ee.value&&(e.deptId=Ee.value);const a=await $.users(e);a.data.success&&(je.value=a.data.data.list||[],Ne.total=a.data.data.total||0,ke.value=a.data.data.total||0)}catch(e){}finally{Be.value=!1}},Ba=async()=>{try{const e=await $.getSettings();if(e.data.success){const a=e.data.data;Le.usernameField=a.usernameField||"email_prefix",Le.syncInterval=a.syncInterval||0,Le.defaultRoleId=a.defaultRoleId||2,Le.autoRegister=a.autoRegister??!0}}catch(e){}Oe.value=!0},Da=async()=>{Ae.value=!0;try{(await $.updateSettings(Le)).data.success&&(P.success("配置保存成功"),Oe.value=!1)}catch(e){}finally{Ae.value=!1}},Na=u(!1),Oa=async()=>{Na.value=!0;try{const e=await N.triggerAll();if(e.data.success){const a=e.data.data;P.success(a.message||"同步任务已触发")}else P.error(e.data.message||"触发同步失败")}catch(e){P.error("触发同步失败")}finally{Na.value=!1}},Aa=async()=>{De.value=!0;try{const e=await $.sync();if(e.data.success){const a=e.data.data;P.success(`同步完成：部门${a.departmentsSynced} 新增${a.usersCreated} 更新${a.usersUpdated}`),Ea(),ja(),ba(),ka()}}catch(e){P.error("同步失败")}finally{De.value=!1}};return a(async()=>{ka(),ba(),Ia(),await(async()=>{try{const e=await B.getDingtalkStatus();e.data.success&&(ge.value=e.data.data.enabled||!1)}catch(e){ge.value=!1}})(),ge.value&&ve.value&&(Ea(),$.users({page:1,pageSize:1}).then(e=>{e.data.success&&(ke.value=e.data.data.total||0)}).catch(()=>{}))}),(e,a)=>{const d=o("el-tag"),u=o("el-icon"),i=o("el-dropdown-item"),T=o("el-dropdown-menu"),$=o("el-dropdown"),j=o("el-tree"),B=o("el-card"),D=o("el-input"),N=o("el-button"),O=o("el-table-column"),ve=o("el-switch"),ge=o("el-table"),be=o("el-pagination"),ze=o("el-alert"),Ue=o("el-form-item"),Pe=o("el-col"),Se=o("el-row"),Te=o("el-tree-select"),$e=o("el-option"),Fe=o("el-select"),Ee=o("el-form"),ra=o("el-dialog"),wa=o("el-input-number"),Ea=b("loading");return r(),l("div",A,[t("div",L,[n(B,{class:"group-tree-card"},{default:s(()=>[n(j,{data:Ce.value,props:{children:"children",label:"label"},"node-key":"_uid",ref_key:"unifiedTreeRef",ref:xe,"highlight-current":"","default-expanded-keys":Ve.value,onNodeClick:Re,"expand-on-click-node":!1},{default:s(({node:e,data:o})=>[t("div",q,[t("span",{class:c({"source-root-label":o._isRoot})},p(o.label),3),t("div",G,[o._isRoot&&"local"===o._source?(r(),m(d,{key:0,size:"small",type:"primary",effect:"dark"},{default:s(()=>[v("本地/"+p(we.value),1)]),_:1})):f("",!0),o._isRoot&&"dingtalk"===o._source?(r(),l(h,{key:1},[n(d,{size:"small",type:"warning",effect:"dark"},{default:s(()=>[v("外部/dingTalk/"+p(ke.value),1)]),_:1}),n($,{trigger:"click",onCommand:a[1]||(a[1]=e=>(e=>{"settings"===e?Ba():"sync"===e&&Aa()})(e)),onClick:a[2]||(a[2]=y(()=>{},["stop"]))},{dropdown:s(()=>[n(T,null,{default:s(()=>[n(i,{command:"settings"},{default:s(()=>[...a[37]||(a[37]=[v("同步配置",-1)])]),_:1}),n(i,{command:"sync"},{default:s(()=>[...a[38]||(a[38]=[v("手动同步",-1)])]),_:1})]),_:1})]),default:s(()=>[n(u,{class:"group-more-btn",style:{opacity:"1","margin-left":"4px"},onClick:a[0]||(a[0]=y(()=>{},["stop"]))},{default:s(()=>[n(g(I))]),_:1})]),_:1})],64)):f("",!0),o._isRoot||"local"!==o._source?f("",!0):(r(),m($,{key:2,trigger:"click",onCommand:e=>((e,a)=>{"edit"===e?(fa.value=!0,ha.value=a.id,ga.name=a.name,ga.parentId=a.parentId||null,va.value=!0):"addChild"===e?(fa.value=!1,ha.value=0,ga.name="",ga.parentId=a.id,va.value=!0):"delete"===e&&S.confirm(`确定删除分组「${a.name}」？该分组下的用户将变为未分组。`,"删除分组",{type:"warning"}).then(async()=>{try{(await F.delete(a.id)).data.success&&(P.success("删除成功"),ka(),ba())}catch(e){}}).catch(()=>{})})(e,o),onClick:a[4]||(a[4]=y(()=>{},["stop"]))},{dropdown:s(()=>[n(T,null,{default:s(()=>[n(i,{command:"edit"},{default:s(()=>[...a[39]||(a[39]=[v("编辑",-1)])]),_:1}),n(i,{command:"addChild"},{default:s(()=>[...a[40]||(a[40]=[v("添加子分组",-1)])]),_:1}),n(i,{command:"delete",divided:""},{default:s(()=>[...a[41]||(a[41]=[t("span",{class:"text-error"},"删除",-1)])]),_:1})]),_:1})]),default:s(()=>[n(u,{class:"group-more-btn",onClick:a[3]||(a[3]=y(()=>{},["stop"]))},{default:s(()=>[n(g(I))]),_:1})]),_:1},8,["onCommand"]))])])]),_:1},8,["data","default-expanded-keys"])]),_:1}),n(B,{class:"user-list-card"},{header:s(()=>[t("div",K,[t("div",M,[n(D,{modelValue:qe.value,"onUpdate:modelValue":a[5]||(a[5]=e=>qe.value=e),placeholder:"用户名/姓名/手机号",clearable:"",class:"keyword-input",onKeyup:w(Ie,["enter"])},null,8,["modelValue"]),n(N,{type:"primary",onClick:Ie},{default:s(()=>[...a[42]||(a[42]=[v("搜索",-1)])]),_:1})]),"local"===_e.value?(r(),l("div",H,[me.value?(r(),m(N,{key:0,type:"warning",onClick:ye,loading:he.value},{default:s(()=>[n(u,null,{default:s(()=>[n(g(C))]),_:1}),a[43]||(a[43]=v(" 导出用户 ",-1))]),_:1},8,["loading"])):f("",!0),ce.value?(r(),m(N,{key:1,onClick:xa},{default:s(()=>[n(u,null,{default:s(()=>[n(g(z))]),_:1}),a[44]||(a[44]=v(" 新增群组 ",-1))]),_:1})):f("",!0),de.value?(r(),m(N,{key:2,type:"success",onClick:Ca},{default:s(()=>[n(u,null,{default:s(()=>[n(g(U))]),_:1}),a[45]||(a[45]=v(" 新增用户 ",-1))]),_:1})):f("",!0),ue.value||ie.value?(r(),m(N,{key:3,type:"primary",onClick:Oa,loading:Na.value},{default:s(()=>[n(u,null,{default:s(()=>[n(g(R))]),_:1}),a[46]||(a[46]=v(" 同步全部 ",-1))]),_:1},8,["loading"])):f("",!0)])):f("",!0),"dingtalk"===_e.value?(r(),l("div",J,[fe.value?(r(),m(N,{key:0,type:"primary",onClick:Aa,loading:De.value},{default:s(()=>[n(u,null,{default:s(()=>[n(g(R))]),_:1}),a[47]||(a[47]=v(" 同步 ",-1))]),_:1},8,["loading"])):f("",!0)])):f("",!0)])]),default:s(()=>["local"===_e.value&&da.value.length>0?(r(),l("div",Q,[t("span",W,[a[48]||(a[48]=v("已选 ",-1)),t("b",null,p(da.value.length),1),a[49]||(a[49]=v(" 名用户",-1))]),ie.value?(r(),m(N,{key:0,type:"warning",size:"small",onClick:Sa},{default:s(()=>[n(u,null,{default:s(()=>[n(g(x))]),_:1}),a[50]||(a[50]=v(" 批量重置密码 ",-1))]),_:1})):f("",!0),oe.value?(r(),m(N,{key:1,type:"danger",size:"small",onClick:Fa},{default:s(()=>[n(u,null,{default:s(()=>[n(g(V))]),_:1}),a[51]||(a[51]=v(" 批量删除 ",-1))]),_:1})):f("",!0),n(N,{size:"small",onClick:Pa},{default:s(()=>[...a[52]||(a[52]=[v("取消选择",-1)])]),_:1})])):f("",!0),"local"===_e.value?_((r(),m(ge,{key:1,ref_key:"userTableRef",ref:ua,data:He.value,stripe:"",size:"small",onSelectionChange:Ra,"header-cell-style":{padding:"8px 0"},"cell-style":{padding:"6px 0"}},{default:s(()=>[n(O,{type:"selection",width:"40",align:"center"}),n(O,{prop:"id",label:"ID",width:"55",align:"center"}),n(O,{prop:"username",label:"用户名","min-width":"110","show-overflow-tooltip":""}),n(O,{prop:"nickname",label:"姓名","min-width":"80","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.nickname||"-"),1)]),_:1}),n(O,{prop:"phone",label:"手机号","min-width":"115","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.phone||"-"),1)]),_:1}),n(O,{prop:"email",label:"邮箱","min-width":"180","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.email||"-"),1)]),_:1}),n(O,{prop:"status",label:"状态",width:"65",align:"center"},{default:s(({row:e})=>[n(ve,{"model-value":1===e.status,onChange:a=>(async(e,a)=>{try{await E.updateStatus(e.id,a?1:0),P.success(a?"已启用":"已禁用"),ba()}catch(l){}})(e,a),"inline-prompt":"",size:"small",disabled:!re.value},null,8,["model-value","onChange","disabled"])]),_:1}),n(O,{label:"操作",width:oe.value?180:130,fixed:"right",align:"center"},{default:s(({row:e})=>[ue.value?(r(),m(N,{key:0,type:"primary",link:"",size:"small",onClick:a=>{return l=e,Xe.value=!0,Ye.value=l.id,Ze.value=l.source||"local",Object.assign(aa,{username:l.username,password:"",nickname:l.nickname,phone:l.phone,email:l.email,status:l.status,roleIds:(null==(t=l.roles)?void 0:t.map(e=>e.id))||[],groupId:l.groupId||null}),Ia(),void(We.value=!0);var l,t}},{default:s(()=>[...a[53]||(a[53]=[v("编辑",-1)])]),_:1},8,["onClick"])):f("",!0),ie.value?(r(),m(N,{key:1,type:"warning",link:"",size:"small",onClick:a=>{return l=e,ta.userId=l.id,ta.username=l.username,ta.nickname=l.nickname||"",ta.phone=l.phone||"",ta.dingtalkUid=l.dingtalkUid||"",ta.notifyChannels=[],sa(l.groupId),void(la.value=!0);var l}},{default:s(()=>[...a[54]||(a[54]=[v("重置密码",-1)])]),_:1},8,["onClick"])):f("",!0),oe.value&&"admin"!==e.username?(r(),m(N,{key:2,type:"danger",link:"",size:"small",onClick:a=>$a(e)},{default:s(()=>[...a[55]||(a[55]=[v("删除",-1)])]),_:1},8,["onClick"])):f("",!0)]),_:1},8,["width"])]),_:1},8,["data"])),[[Ea,Ge.value]]):f("",!0),"dingtalk"===_e.value?_((r(),m(ge,{key:2,data:je.value,stripe:"",size:"small","header-cell-style":{padding:"8px 0"},"cell-style":{padding:"6px 0"}},{default:s(()=>[n(O,{prop:"name",label:"姓名","min-width":"80","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.name||"-"),1)]),_:1}),n(O,{prop:"departmentName",label:"部门","min-width":"110","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.departmentName||"-"),1)]),_:1}),n(O,{prop:"jobTitle",label:"职位","min-width":"120","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.jobTitle||"-"),1)]),_:1}),n(O,{prop:"mobile",label:"手机号","min-width":"115","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.mobile||"-"),1)]),_:1}),n(O,{prop:"email",label:"邮箱","min-width":"180","show-overflow-tooltip":""},{default:s(({row:e})=>[v(p(e.email||"-"),1)]),_:1}),n(O,{label:"已同步",width:"70",align:"center"},{default:s(({row:e})=>[n(d,{type:e.localUserId>0?"success":"info",size:"small",effect:"plain"},{default:s(()=>[v(p(e.localUserId>0?"是":"否"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[Ea,Be.value]]):f("",!0),t("div",X,[t("span",Y,"共 "+p("local"===_e.value?Qe.total:Ne.total)+" 条",1),"local"===_e.value?(r(),m(be,{key:0,"current-page":Qe.page,"onUpdate:currentPage":a[6]||(a[6]=e=>Qe.page=e),"page-size":Qe.size,"onUpdate:pageSize":a[7]||(a[7]=e=>Qe.size=e),total:Qe.total,"page-sizes":[20,50,100],layout:"sizes, prev, pager, next",onCurrentChange:ba,onSizeChange:ba},null,8,["current-page","page-size","total"])):f("",!0),"dingtalk"===_e.value?(r(),m(be,{key:1,"current-page":Ne.page,"onUpdate:currentPage":a[8]||(a[8]=e=>Ne.page=e),"page-size":Ne.size,"onUpdate:pageSize":a[9]||(a[9]=e=>Ne.size=e),total:Ne.total,"page-sizes":[20,50,100],layout:"sizes, prev, pager, next",onCurrentChange:ja,onSizeChange:ja},null,8,["current-page","page-size","total"])):f("",!0)])]),_:1})]),n(ra,{modelValue:We.value,"onUpdate:modelValue":a[20]||(a[20]=e=>We.value=e),title:Xe.value?"编辑用户":"新增用户",width:"520px","destroy-on-close":""},{footer:s(()=>[n(N,{onClick:a[19]||(a[19]=e=>We.value=!1)},{default:s(()=>[...a[57]||(a[57]=[v("取消",-1)])]),_:1}),n(N,{type:"primary",onClick:za,loading:Ke.value},{default:s(()=>[...a[58]||(a[58]=[v("保存",-1)])]),_:1},8,["loading"])]),default:s(()=>[ea.value?(r(),m(ze,{key:0,type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:s(()=>[...a[56]||(a[56]=[v(" 该用户由IM平台同步，基本信息不可手动修改，如需变更请在对应平台管理后台修改后重新同步。 ",-1)])]),_:1})):f("",!0),n(Ee,{model:aa,"label-width":"80px"},{default:s(()=>[Xe.value?(r(),m(Ue,{key:1,label:"用户名"},{default:s(()=>[n(D,{modelValue:aa.username,"onUpdate:modelValue":a[11]||(a[11]=e=>aa.username=e),disabled:""},null,8,["modelValue"])]),_:1})):(r(),m(Ue,{key:0,label:"用户名",required:""},{default:s(()=>[n(D,{modelValue:aa.username,"onUpdate:modelValue":a[10]||(a[10]=e=>aa.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1})),Xe.value?f("",!0):(r(),m(Ue,{key:2,label:"密码",required:""},{default:s(()=>[n(D,{modelValue:aa.password,"onUpdate:modelValue":a[12]||(a[12]=e=>aa.password=e),type:"password","show-password":"",placeholder:"请输入密码"},null,8,["modelValue"])]),_:1})),n(Se,{gutter:16},{default:s(()=>[n(Pe,{span:12},{default:s(()=>[n(Ue,{label:"姓名"},{default:s(()=>[n(D,{modelValue:aa.nickname,"onUpdate:modelValue":a[13]||(a[13]=e=>aa.nickname=e),placeholder:"请输入姓名",disabled:ea.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),n(Pe,{span:12},{default:s(()=>[n(Ue,{label:"手机号"},{default:s(()=>[n(D,{modelValue:aa.phone,"onUpdate:modelValue":a[14]||(a[14]=e=>aa.phone=e),placeholder:"请输入手机号",disabled:ea.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),n(Ue,{label:"邮箱"},{default:s(()=>[n(D,{modelValue:aa.email,"onUpdate:modelValue":a[15]||(a[15]=e=>aa.email=e),placeholder:"请输入邮箱",disabled:ea.value},null,8,["modelValue","disabled"])]),_:1}),n(Ue,{label:"所属分组"},{default:s(()=>[n(Te,{modelValue:aa.groupId,"onUpdate:modelValue":a[16]||(a[16]=e=>aa.groupId=e),data:_a.value,props:{children:"children",label:"name",value:"id"},placeholder:"选择分组（可选）",clearable:"","check-strictly":"",disabled:ea.value,style:{width:"100%"}},null,8,["modelValue","data","disabled"])]),_:1}),n(Se,{gutter:16},{default:s(()=>[n(Pe,{span:12},{default:s(()=>[n(Ue,{label:"状态"},{default:s(()=>[n(ve,{modelValue:aa.status,"onUpdate:modelValue":a[17]||(a[17]=e=>aa.status=e),"active-value":1,"inactive-value":0,"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1}),pe.value?(r(),m(Pe,{key:0,span:12},{default:s(()=>[n(Ue,{label:"角色"},{default:s(()=>[n(Fe,{modelValue:aa.roleIds,"onUpdate:modelValue":a[18]||(a[18]=e=>aa.roleIds=e),multiple:"",placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(r(!0),l(h,null,k(Je.value,e=>(r(),m($e,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})):f("",!0)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(ra,{modelValue:la.value,"onUpdate:modelValue":a[22]||(a[22]=e=>la.value=e),title:"重置密码",width:"480px","destroy-on-close":""},{footer:s(()=>[n(N,{onClick:a[21]||(a[21]=e=>la.value=!1)},{default:s(()=>[...a[60]||(a[60]=[v("取消",-1)])]),_:1}),n(N,{type:"primary",onClick:Ua,loading:Me.value},{default:s(()=>[...a[61]||(a[61]=[v("确认重置",-1)])]),_:1},8,["loading"])]),default:s(()=>[n(ze,{type:"info",closable:!1,"show-icon":"",class:"mb-lg"},{default:s(()=>[...a[59]||(a[59]=[v(" 系统将自动生成符合密码策略的随机密码，并通过消息策略配置的通知渠道发送给员工。管理员无法查看生成的密码。 ",-1)])]),_:1}),n(Ee,{"label-width":"100px"},{default:s(()=>[n(Ue,{label:"用户"},{default:s(()=>[t("span",Z,p(ta.username),1),ta.nickname?(r(),m(d,{key:0,size:"small",style:{"margin-left":"8px"}},{default:s(()=>[v(p(ta.nickname),1)]),_:1})):f("",!0)]),_:1}),n(Ue,{label:"手机号"},{default:s(()=>[t("span",null,p(ta.phone||"未设置"),1)]),_:1}),n(Ue,{label:"通知渠道"},{default:s(()=>[na.value.length>0?(r(),l("div",ee,[(r(!0),l(h,null,k(na.value,e=>(r(),m(d,{key:e,size:"small",type:"success"},{default:s(()=>[v(p(e),1)]),_:2},1024))),128))])):(r(),l("span",ae,"未配置消息策略，请在「规则与策略」中设置"))]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(ra,{modelValue:oa.value,"onUpdate:modelValue":a[24]||(a[24]=e=>oa.value=e),title:"批量重置密码",width:"600px","destroy-on-close":""},{footer:s(()=>[n(N,{onClick:a[23]||(a[23]=e=>oa.value=!1)},{default:s(()=>[...a[65]||(a[65]=[v("取消",-1)])]),_:1}),n(N,{type:"primary",onClick:Ta,loading:ca.value},{default:s(()=>[...a[66]||(a[66]=[v("确认批量重置",-1)])]),_:1},8,["loading"])]),default:s(()=>[n(ze,{type:"warning",closable:!1,"show-icon":"",class:"mb-lg"},{default:s(()=>[a[62]||(a[62]=v(" 将为选中的 ",-1)),t("b",null,p(ia.value.length),1),a[63]||(a[63]=v(" 名用户自动生成随机密码，并通过消息策略配置的渠道通知。此操作不可撤销。 ",-1))]),_:1}),t("div",le,[a[64]||(a[64]=t("div",{style:{"font-weight":"500","margin-bottom":"8px",color:"#303133"}},"选中用户",-1)),n(ge,{data:ia.value,"max-height":"240",border:"",size:"small"},{default:s(()=>[n(O,{prop:"username",label:"用户名",width:"120"}),n(O,{prop:"nickname",label:"姓名",width:"100"},{default:s(({row:e})=>[v(p(e.nickname||"-"),1)]),_:1}),n(O,{prop:"phone",label:"手机号",width:"130"},{default:s(({row:e})=>[t("span",{class:c({"text-error":!e.phone})},p(e.phone||"未设置"),3)]),_:1})]),_:1},8,["data"])]),n(Ee,{"label-width":"100px"},{default:s(()=>[n(Ue,{label:"通知渠道"},{default:s(()=>[na.value.length>0?(r(),l("div",te,[(r(!0),l(h,null,k(na.value,e=>(r(),m(d,{key:e,size:"small",type:"success"},{default:s(()=>[v(p(e),1)]),_:2},1024))),128))])):(r(),l("span",ne,"未配置消息策略"))]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(ra,{modelValue:pa.value,"onUpdate:modelValue":a[26]||(a[26]=e=>pa.value=e),title:"批量重置结果",width:"600px"},{footer:s(()=>[n(N,{type:"primary",onClick:a[25]||(a[25]=e=>pa.value=!1)},{default:s(()=>[...a[67]||(a[67]=[v("确定",-1)])]),_:1})]),default:s(()=>[n(ze,{type:ma.success===ma.total?"success":"warning",closable:!1,"show-icon":"",class:"mb-lg"},{default:s(()=>[v(" 共 "+p(ma.total)+" 人，成功 "+p(ma.success)+" 人 ",1)]),_:1},8,["type"]),n(ge,{data:ma.results,"max-height":"360",border:"",size:"small"},{default:s(()=>[n(O,{prop:"username",label:"用户名",width:"120"}),n(O,{prop:"nickname",label:"姓名",width:"100"}),n(O,{label:"状态",width:"80",align:"center"},{default:s(({row:e})=>[n(d,{type:e.success?"success":"danger",size:"small"},{default:s(()=>[v(p(e.success?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),n(O,{prop:"notifyResult",label:"通知结果","min-width":"200"})]),_:1},8,["data"])]),_:1},8,["modelValue"]),n(ra,{modelValue:va.value,"onUpdate:modelValue":a[30]||(a[30]=e=>va.value=e),title:fa.value?"编辑分组":"新增分组",width:"420px","destroy-on-close":""},{footer:s(()=>[n(N,{onClick:a[29]||(a[29]=e=>va.value=!1)},{default:s(()=>[...a[68]||(a[68]=[v("取消",-1)])]),_:1}),n(N,{type:"primary",onClick:Va,loading:ya.value},{default:s(()=>[...a[69]||(a[69]=[v("保存",-1)])]),_:1},8,["loading"])]),default:s(()=>[n(Ee,{model:ga,"label-width":"80px"},{default:s(()=>[n(Ue,{label:"分组名称",required:""},{default:s(()=>[n(D,{modelValue:ga.name,"onUpdate:modelValue":a[27]||(a[27]=e=>ga.name=e),placeholder:"请输入分组名称"},null,8,["modelValue"])]),_:1}),n(Ue,{label:"上级分组"},{default:s(()=>[n(Te,{modelValue:ga.parentId,"onUpdate:modelValue":a[28]||(a[28]=e=>ga.parentId=e),data:_a.value,props:{children:"children",label:"name",value:"id"},placeholder:"无（顶级分组）",clearable:"","check-strictly":"",style:{width:"100%"}},null,8,["modelValue","data"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),n(ra,{modelValue:Oe.value,"onUpdate:modelValue":a[36]||(a[36]=e=>Oe.value=e),title:"钉钉同步配置",width:"520px","destroy-on-close":""},{footer:s(()=>[n(N,{onClick:a[35]||(a[35]=e=>Oe.value=!1)},{default:s(()=>[...a[72]||(a[72]=[v("取消",-1)])]),_:1}),n(N,{type:"primary",onClick:Da,loading:Ae.value},{default:s(()=>[...a[73]||(a[73]=[v("保存",-1)])]),_:1},8,["loading"])]),default:s(()=>[n(Ee,{model:Le,"label-width":"130px"},{default:s(()=>[n(Ue,{label:"用户名生成策略"},{default:s(()=>[n(Fe,{modelValue:Le.usernameField,"onUpdate:modelValue":a[31]||(a[31]=e=>Le.usernameField=e),style:{width:"100%"}},{default:s(()=>[n($e,{label:"邮箱前缀（默认）",value:"email_prefix"}),n($e,{label:"完整邮箱",value:"email"}),n($e,{label:"钉钉UserID",value:"dingtalk_userid"}),n($e,{label:"手机号",value:"mobile"}),n($e,{label:"姓名拼音",value:"pinyin"})]),_:1},8,["modelValue"]),t("div",se,["email_prefix"===Le.usernameField?(r(),l(h,{key:0},[v(" 例：yanze@duiba.com.cn → yanze ")],64)):"pinyin"===Le.usernameField?(r(),l(h,{key:1},[v(" 例：闫泽 → yanze（重名自动加数字：yanze2） ")],64)):"mobile"===Le.usernameField?(r(),l(h,{key:2},[v(" 使用钉钉绑定手机号作为用户名 ")],64)):"dingtalk_userid"===Le.usernameField?(r(),l(h,{key:3},[v(" 使用钉钉UserID作为用户名 ")],64)):"email"===Le.usernameField?(r(),l(h,{key:4},[v(" 使用完整邮箱地址作为用户名 ")],64)):f("",!0)])]),_:1}),n(Ue,{label:"自动同步间隔(分钟)"},{default:s(()=>[n(wa,{modelValue:Le.syncInterval,"onUpdate:modelValue":a[32]||(a[32]=e=>Le.syncInterval=e),min:0,max:1440,step:30},null,8,["modelValue"]),a[70]||(a[70]=t("div",{class:"form-tip"},"设为 0 则不自动同步",-1))]),_:1}),n(Ue,{label:"默认角色"},{default:s(()=>[n(Fe,{modelValue:Le.defaultRoleId,"onUpdate:modelValue":a[33]||(a[33]=e=>Le.defaultRoleId=e),placeholder:"选择默认角色",style:{width:"100%"}},{default:s(()=>[(r(!0),l(h,null,k(Je.value,e=>(r(),m($e,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(Ue,{label:"自动注册"},{default:s(()=>[n(ve,{modelValue:Le.autoRegister,"onUpdate:modelValue":a[34]||(a[34]=e=>Le.autoRegister=e),"active-text":"是","inactive-text":"否"},null,8,["modelValue"]),a[71]||(a[71]=t("div",{class:"form-tip"},"钉钉免登时自动创建本地用户",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-68ad063a"]]);export{de as default};
